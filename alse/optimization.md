# Обновление ключей

```
sudo pacman-key --init               # Инициализация
sudo pacman-key --populate archlinux # Получить ключи из репозитория
sudo pacman-key --refresh-keys       # Проверить текущие ключи на актуальность
sudo pacman -Sy                      # Обновить ключи для всей системы
```

# Установка актуальных драйверов для видеокарты

## NVIDIA

```
sudo pacman -S nvidia-dkms nvidia-utils nvidia-settings vulkan-icd-loader opencl-nvidia libxnvctrl
sudo mkinitcpio -P # Обновляем образы initramfs
```

## Nouveau (Только для старых видеокарт)

```
sudo pacman -S xf86-video-nouveau vulkan-icd-loader mesa-vdpau
```

## AMD

```
sudo pacman -S vulkan-radeon vulkan-icd-loader mesa-vdpau vulkan-mesa-layers
```

## Intel

```
sudo pacman -S vulkan-intel vulkan-icd-loader
```

# Добавление важных модулей в образы initramfs

Отредактировать файл /etc/mkinitcpio.con:

```
MODULES=(crc32c libcrc32c zlib_deflate btrfs crc32c-intel intel_agp i915)
```

Далее выполнить команду:

```
sudo mkinitcpio -P
```

# Установка микрокода

```
sudo pacman -S intel-ucode                  # Установить микрокод Intel
sudo mkinitcpio -P                          # Пересобираем образы initramfs.
sudo grub-mkconfig -o /boot/grub/grub.cfg   # Обновляем загрузчик, можно так же через grub-customizer.
```

# Настройка makepkg.conf

Отредактировать файл /etc/makepkg.conf:

```
CFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt -fexceptions \
      -Wp,-D_FORTIFY_SOURCE=2 -Wformat -Werror=format-security \
      -fstack-clash-protection -fcf-protection"
CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"
RUSTFLAGS="-C opt-level=3"
MAKEFLAGS="-j$(nproc) -l$(nproc)"
OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)
```

# Включение ccache

```
sudo pacman -S ccache
```

Отредактировать /etc/makepkg.conf:

```
# Найдите данную строку в собственных настройках, затем уберите восклицательный знак перед *"ccache"*
BUILDENV=(!distcc color ccache check !sign)
```

# Установка полезных служб и демонов

## Включение Nohang

Демон повышающий производительность путём обработки и слежки за потреблением памяти

```
git clone https://aur.archlinux.org/nohang-git.git # Скачивание исходников.
cd nohang-git                                      # Переход в nohang-git
makepkg -sric                                      # Сборка и установка.
sudo systemctl enable --now nohang-desktop         # Включаем службу.
```

## Включение TRIM

```
sudo systemctl enable fstrim.timer    # Включаем службу.
sudo fstrim -v /                      # Ручной метод.
sudo fstrim -va /                     # Если первый метод не тримит весь диск.
```

## Включение cronie

Демон, который поможет вам очищать вашу систему от мусора полностью автономно

```
sudo pacman -S cronie                         # Установить cron.
sudo systemctl enable --now cronie.service    # Запускает и включает службу.
sudo EDITOR=nano crontab -e                   # Редактируем параметр.
```

И прописываем:

```
15 10 * * sun /sbin/pacman -Scc --noconfirm
```

## Включение rng-tools

Демон, что также следит за энтропией системы, но в отличие от haveged уже через аппаратный таймер. Необходим для ускорения запуска системы при высоких показателях systemd-analyze blame (больше 1 секунды)

```
sudo pacman -S rng-tools         # Установка
sudo systemctl enable --now rngd # Включает и запускает службу.
```

## Включение dbus-broker

Это реализация шины сообщений в соответствии со спецификацией D-Bus. Её цель - обеспечить высокую производительность и надежность при сохранении совместимости с эталонной реализацией D-Bus. Обеспечивает чуть более быстрое общение с видеокартой через PCIe.

```
sudo pacman -S dbus-broker                         # Уставновка
sudo systemctl enable --now dbus-broker.service    # Включает и запускает службу.
sudo systemctl --global enable dbus-broker.service # Включает и запускает службу для всех пользователей.
```

## Включение irqbalance

Демон, что автоматически балансирует обработку прерываний по ядрам процессора

```
udo pacman -S irqbalance
sudo systemctl enable --now irqbalance
```

# Низкие задержки звука

```
sudo pacman -S alsa alsa-utils alsa-firmware alsa-card-profiles alsa-plugins
```

# Ускорение загрузки системы

```
sudo systemctl mask NetworkManager-wait-online.service
```

# Одновременная загрузка двух и более пакетов

Отредактировать /etc/pacman.conf:

```
# Где 4 - количество пакетов для одновременной загрузки
ParallelDownloads = 4
```

# Перевод процессора из стандартного энергосбережения в режим производительности\

```
sudo pacman -S cpupower                       # Установит менеджер управления частотой процессора
sudo systemctl enable cpupower # Включить как постоянную службу

git clone https://aur.archlinux.org/cpupower-gui.git
cd cpupower-gui
makepkg -sric
```

Лучше установить Onedemand

# Установка оптимизированных пакетов

Проверить поколение процессора (искать supported, searched):

```
/lib/ld-linux-x86-64.so.2 --help | grep -B 3 -E "x86-64-v2"
```

Установка ключей для проверки подписей пакетов:

```
# Ключи для пакетов
git clone https://aur.archlinux.org/alhp-keyring.git
cd alhp-keyring
makepkg -sric

git clone https://aur.archlinux.org/alhp-mirrorlist.git
cd alhp-mirrorlist
makepkg -sric
```

Добавить репозиторий для нужной архитектуры в /etc/pacman.conf:

```
[core-x86-64-v2]
Include = /etc/pacman.d/alhp-mirrorlist

[extra-x86-64-v2]
Include = /etc/pacman.d/alhp-mirrorlist

[community-x86-64-v2]
Include = /etc/pacman.d/alhp-mirrorlist

[core]
Include = /etc/pacman.d/mirrorlist

[extra]
Include = /etc/pacman.d/mirrorlist

[community]
Include = /etc/pacman.d/mirrorlist
```

Полностью обновить систему:

```
sudo pacman -Syyuu
```

# Обновление загрузчика и отключение ненужных заплаток

Отредактировать /etc/default/grub:

```
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash rootfstype=btrfs lpj=3499912 raid=noautodetect elevator=noop mitigations=off preempt=none nowatchdog audit=0 page_alloc.shuffle=1 split_lock_detect=off"
```

**Разъяснения:**

_lpj=_ Определить значение: sudo dmesg | grep "lpj="

_mitigations=off_ Отключает все заплатки безопасности ядра

_raid=noautodetect_ Отключает проверку на RAID во время загрузки

_rootfstype=btrfs_ Название корневой файловой системы

_elevator=noop_ Указывает для всех дисков планировщик ввода NONE

_nowatchdog_ Отключает сторожевые таймеры

_page_alloc.shuffle=1_ Рандомизирует свободные списки распределителя страниц

_split_lock_detect=off_ Отключает раздельные блокировки шины памяти

После операций обновление загрузчика:

```
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

# Файловые системы

Лучше выбрать BTRFS

## Файловая система ext4

Оптимальные параметры монтирования:

```
relatime,commit=300,nombcache,data=writeback
```

## Файловая система btrfs

Оптимальные флаги монтирования:

```
rw,relatime,ssd_spread,space_cache=v2,max_inline=256,commit=300
```

Отключать CoW только на домашней директории:

```
sudo chattr -R +C /home
```

## Сжатие в файловой системе Btrfs

Официально имеется 3 поддерживаемых алгоритма:

1. zlib - высокая степень сжатия, но низкая скорость сжатия и распаковки (N = 1,2,...9)
2. lzo - высокая скорость сжатия и распаковки, но наименьший уровень сжатия из представленных алгоритмов (N - не указываются)
3. zstd - степень сжатия сравнимая с zlib и более быстрые сжатие и распаковка, однако уступающие по скорости lzo (N =1,2,..15)

Отредактировать файл etc/fstab, добавив для необходимого раздела или носителя следующий флаг монтирования:

```
compress='алгоритм':N
```

Для сжатия уже имеющихся данных необходимо выполнить команду:

```
sudo btrfs filesystem defragment -r -calg /path
```

Где -calg - алгоритм

# Кастомные ядра

## Выбор ядра

### linux-zen

Zen ядро - это плод коллективных усилий по объединению патчей улучшающих опыт домашнего использования Linux, но при этом работающих стабильно и не ломающих совместимость с теми или иными вещами.
Это отличный выбор для неискушенного пользователя, что не ставит задачи в получении максимальной производительности и покорении максимальной планки FPS. Рекомендуется установить всем, кто не хочет сильно париться с компиляцией и настройкой других ядер. Ядро можно установить из репозиториев, ибо оно имеет официальную поддержку дистрибутивом.
Из основных улучшений:

1. Улучшено поведение планировщика CFS для значительного снижения задержек в несколько раз.
2. Задействован эффективный алгоритм сжатия LZ4 для файла подкачки через zswap.
3. Используется планировщик ввода/ввода (IO) BFQ, имеющий более низкие задержки и бОльшую пропускную способность (Подробнее - тут).
4. Ядро приспособлено к сохранению качества отклика системы при высокой нагрузке.

Установка:

```
git clone https://aur.archlinux.org/linux-zen-git.git
cd linux-zen-git
makepkg -sric
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

### liquorix

linux-lqx - является по сути тем же Zen, но заточенным под Debian системы. Несмотря на это, авторы ARU считают его лучшим ядром на Arch Linux, по крайне мере для процессоров Intel. Содержит множество изменений не вошедших в Zen (в виду разных причин):

1. Планировщик PDS по умолчанию (На выбор предоставляются также BMQ и CFS), имеющий лучшие результаты в повседневных задачах.
2. Алгоритм TCP BBR2 обеспечивающий более высокую скорость работы и максимизирует пропускную способность
3. Multigenerational LRU для сохранения качества отклика в условиях нехватки оперативной памяти.
4. 1000Hz тактовая частота по умолчанию для более точного планирования с минимумом зависаний.
5. Предпочтительно жёсткое вытеснение процессов из очереди. Это гарантирует вам то, что не один процесс не сможет выжрать все процессорное время (дать системе зависнуть).
6. Содержит минимальное количество отладочных функций.
7. Другие внутренние изменения ядра.

Установка:

```
git clone https://aur.archlinux.org/linux-lqx.git                 # Скачивание исходников.
cd linux-lqx                                                      # Переход в linux-lqx
gpg --keyserver keyserver.ubuntu.com --recv-keys 38DBBDC86092693E # GPG ключ
sed -i 's/_makenconfig=/_makenconfig=y/' PKGBUILD                 # Включаем ручную настройку
makepkg -sric
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

### Xanmod

Альтернатива liquorix, так же нацеленная на оптимизацию под игрушки и повышение плавности работы системы. Новомодное ядро, которое включает в себе часть уже описанных выше изменений из zen/lqx. Помимо прочего имеет:

1. Улучшенный метод обработки TCP пакетов (BBRv2)
2. Частично включает в себя патчи от Clear Linux (так же как и linux-lqx)
3. WineSync, альтернатива Fsync, ещё одна реализация синхронизации NT примитов для Wine, но вынесенная в качестве отдельного модуля. Для остальных ядер может быть установлена через AUR пакет winesync-dkms.
4. Высокая пропускная способность устройств ввода/вывода.
5. Улучшения систем кэширования и управления памятью.

Установка:

```
git clone https://aur.archlinux.org/linux-xanmod.git                    # Скачивание исходников.
cd linux-xanmod                                                         # Переход в linux-xanmod
gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 38DBBDC86092693E # GPG ключ
export _makenconfig=y _use_numa=n use_tracers=n _compiler=clang         # Включаем ручную настройку
makepkg -sric     
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

### linux-tkg

Является альтернативой всем трем ядрам выше, что предоставляет возможность собрать ядро с набором множества патчей на улучшение производительности в игрушках (Futex2, Zenify). Предоставляет выбор в сборке ядра с разными планировщиками. Грубо говоря, это ядро сборная солянка из всех остальных ядер с большим набором патчей.

Установка:

```
git clone https://github.com/Frogging-Family/linux-tkg.git
cd linux-tkg
micro customization.cfg
```

**_version="6.0"** - Здесь выбираем версию ядра которую мы хотим установить. Выбирайте самую последнюю из доступных.

**_modprobeddb="false"** - Опция отвечающая за сборку мини-ядра. Подробнее о нем вы можете узнать в соответствующем разделе. Если хотите собрать мини-ядро - пишите "true", если нет - "false".

**_menunconfig="2"** - Выбор настройки ядра через menuconfg/xconfig/nconfig. Рекомендуется выбрать "2" чтобы перед сборкой можно было выполнить непосредственную настройку ядра через menunconfig как мы уже делали ранее с liquorix.

**_cpusched="pds"** - Выбор CPU планировщика ядра. К выбору предоставляется довольно много планировщиков, но мы советуем обратить ваше внимание только на некоторых из них: "pds", "bmq", "cacule", "cfs" (дефолтный для ванильного ядра), "bore". По некоторым данным, PDS дает больше FPS, а CacULE дает лучшие задержки по времени кадра (плавность). Однако все слишком ситуативно чтобы выбрать из них лучшего, в каких-то играх/задачах будет выигрывать PDS, а в каких-то CaCULE и так далее.

**_rr_interval="default"** - Задает продолжительность удержания двумя задачами одинакового приоритета. Рекомендуемое значение слишком зависит от выбранного планировщика, поэтому лучше всего задавайте "default".

**_default_cpu_gov="performance"** - Выбирает режим по умолчанию в котором будет масштабироваться частота процессора. Рекомендуется "performance" чтобы процессор по умолчанию работал в режиме высокой производительности.

**_aggressive_ondemand="false"** - Задает агрессивное применение динамического управления частотой процессора по необходимости в выполняемой задаче, обеспечивая тем самым энергоэффективность. Но т.к. выше мы уже закрепили режим масштабирования "performance", то мы должны отключить этот параметр. Однако пользователи ноутбуков могут оставить этот параметр включенным.

**_sched_yield_type="0"** - Настраивает выполнение освобождения процесса от потребления процессорного времени путем его переноса в конец очереди выполнения процессов. Рекомендуемое значение для лучшей производительности - "0", т.е. не осуществлять перенос в конец очереди для освобождения процесса.

**_tickless="2"** - Рекомендуется выбирать "Холостые Динамические тики" таймера ядра. Подробнее об данной настройке вы можете прочитать в разделе "Настройка ядра".

**_timer_freq="1000"** - Задает частоту таймера. Рекомендуется 1000 для лучшей отзывчивости системы на домашнем ПК или ноутбуке.

**_fsync="true"** - Задействует поддержку ядром замены Esync от компании Valve - Fsync. Обязательно к включению ("true") для лучшей производительности в играх.

**_futex2="true"** - Осуществляет использование нового, экспериментального futex2 вызова что может дать лучшую производительность для игрушек запускаемых через Wine/Proton. Для обычных ядер поддержка Futex2 включена начиная с версии 5.16+.

**_winesync="false"** - Ещё одна замена esync, но уже от разработчиков Wine.

**_zenify="true"** - Применяет твики Zen и Liquorix для улучшения производительности в играх. Настоятельно рекомендуется к включению.

**_compileroptlevel="1"** - Задает степень оптимизации ядра во время сборки. Лучше всего выбирать "1", т.е. сборку с -O2 флагом (высокая производительность).

**_processor_opt="native_intel"** - С учетом какой архитектуры процессора собирать ядро. Настоятельно рекомендуется указать здесь либо архитектуру непосредственно вашего процессора (К примеру: "skylake"), либо фирму производитель, где для Intel это - "native_intel", для AMD - "native_amd".

**_ftracedisable="true"** - Отключает лишние трекеры для отладки ядра.

**_acs_override="true"** - Включает патч на разделение сгруппированных PCI устройств в IOMMU, которые могут понадобиться вам отдельно. По умолчанию есть в linux-zen и linux-lqx. Подробнее читайте - здесь. Советуем включить если в будущем вы хотите выполнить операцию проброса вашей видеокарты в виртуальную машину.

Сборка и установка ядра:

```
makepkg -sric # Сборка и установка linux-tkg
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

### linux-cachyos

linux-cachyos - добротная альтернатива всем остальным ядрам, также нацеленная на максимальную производительность вашей системы. По субъективным ощущениям автора работает лучше чем Xanmod и TKG. Предлагает на выбор множество планировщиков CPU. Сочетает в себе патчи которые уже были описаны для других ядер. А именно:

1. Улучшенный планировщик ввода/вывода BFQ
2. Набор патчей LRU для сохранения качества отклика системы в условиях нехватки оперативной памяти.
3. Содержит новейшие исправления для Btrfs/Zstd
4. Заточен для сборки через LLVM/Clang (более подробно это описывается в последующем разделе)
5. Алгоритм для обработки сетевых пакетов BBRv2
6. Модули для поддержки эмуляции Android (Anbox)
7. Набор патчей от Clear Linux
8. И некоторые собственные настройки для ядра

Отдельным плюсом является быстрая обновляемость и оперативные исправления ошибок, чем к сожалению не всегда может похвастаться linux-tkg.

Установка (можно использовать планировщики CFS, BMQ, PDS, TT и BORE):

```
git clone https://github.com/CachyOS/linux-cachyos.git  # Скачиваем исходники
cd linux-cachyos/linux-cachyos-bore # Если хотите использовать PDS, то соответственно пишите cd linux-cachyos-pds по аналогии
makepkg -sric
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

