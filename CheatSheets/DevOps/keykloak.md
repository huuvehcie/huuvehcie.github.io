# Keycloak

## Содержание
- [Терминология](#терминология)
- [Установка и настройка](#установка-и-настройка)
- [Управление пользователями](#управление-пользователями)
- [Управление ролями и клиентами](#управление-ролями-и-клиентами)
- [Интеграция и безопасность](#интеграция-и-безопасность)
- [Автоматизация и оптимизация](#автоматизация-и-оптимизация)
- [Справочник параметров конфигурации](#справочник-параметров-конфигурации)

## Терминология

| Термин | Описание |
|--------|----------|
| **Realm** | Изолированная область в Keycloak, содержащая пользователей, роли, клиентов и настройки. Используется для разделения приложений или организаций. Каждый realm независим и не взаимодействует с другими без явной настройки. |
| **Клиент** | Приложение или сервис, интегрированный с Keycloak для аутентификации. Клиенты определяют протоколы (например, OAuth2, OpenID Connect) и настройки доступа. |
| **Роль** | Набор разрешений, назначаемый пользователям или клиентам. Роли бывают realm-уровня и клиент-уровня, определяют доступ к ресурсам. |
| **Пользователь** | Сущность, представляющая человека или систему, аутентифицируемая в Keycloak. Пользователи имеют атрибуты, роли и учетные данные. |
| **Identity Provider (IdP)** | Внешний провайдер идентификации (например, Google, LDAP), интегрированный с Keycloak для федеративной аутентификации. |
| **Токен** | JWT или другой формат, выдаваемый Keycloak для аутентификации и авторизации. Содержит информацию о пользователе и срок действия. |
| **Admin CLI (kcadm)** | Командный интерфейс для управления Keycloak. Используется для автоматизации задач, таких как создание пользователей или настройка realm. |
| **SSO (Single Sign-On)** | Единая точка входа, позволяющая пользователю аутентифицироваться один раз и получать доступ ко всем подключенным приложениям. |
| **Жаргон: "Брокер"** | Identity Brokering — механизм Keycloak для интеграции с внешними IdP, позволяющий перенаправлять аутентификацию на другой провайдер. |
| **Жаргон: "Скоуп"** | Scope — область действия токена, определяющая, какие данные или ресурсы доступны клиенту. |

## Установка и настройка

Keycloak — это мощный инструмент для управления идентификацией и доступом, и его правильная установка является основой для дальнейшей работы. Таблица ниже описывает ключевые команды и параметры для установки и базовой настройки сервера Keycloak, включая запуск, конфигурацию базы данных и настройку администратора. Эти шаги необходимы для развертывания сервера в различных окружениях, таких как Docker или bare-metal системы. Таблица охватывает команды для разных операционных систем, указывает типичные ошибки и их решения, а также влияние настроек на производительность и безопасность системы. Она будет полезна для быстрого старта, а также для понимания, как изменения в конфигурации влияют на взаимодействие с другими компонентами, такими как базы данных или внешние клиенты.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `./kc.sh start` | Запуск сервера Keycloak | `--http-port` — порт HTTP<br>`--db` — тип БД (postgres, mysql)<br>`--db-url` — URL БД<br>`--features` — включение функций (например, token-exchange) | ```bash<br># Локальный запуск с PostgreSQL<br>./kc.sh start --db=postgres --db-url=jdbc:postgresql://localhost:5432/keycloak<br>```<br>```bash<br># Запуск в продакшене<br>./kc.sh start --optimized --http-port=8080<br>``` | **Ошибка**: "Database connection failed"<br>**Решение**: Проверить URL БД, доступность сервера БД.<br>**Ошибка**: "Port already in use"<br>**Решение**: Изменить порт через `--http-port`. | Изменение порта влияет на доступность сервера. Выбор БД определяет производительность. | Требует настроенной БД. Влияет на доступ клиентов. |
| `./kc.sh config` | Конфигурация сервера | `--admin-username` — имя админа<br>`--admin-password` — пароль админа | ```bash<br># Создание учетной записи админа<br>./kc.sh config --admin-username=admin --admin-password=securepass<br>``` | **Ошибка**: "Admin user already exists"<br>**Решение**: Удалить файл конфигурации или изменить имя пользователя. | Создает учетную запись для доступа к консоли. | Взаимодействует с консолью администрирования. |
| `docker run` | Запуск в Docker | `-e` — переменные окружения<br>`-p` — маппинг портов | ```bash<br># Запуск контейнера<br>docker run -p 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=pass quay.io/keycloak/keycloak:latest start<br>``` | **Ошибка**: "Container fails to start"<br>**Решение**: Проверить наличие переменных окружения. | Упрощает развертывание, но требует больше ресурсов. | Требует Docker, взаимодействует с БД через переменные. |

**Важно запомнить**: Всегда используйте `--optimized` в продакшене для повышения производительности. На Windows команды выполняются через `kc.bat`.

**Типичные ошибки**: Неправильный URL базы данных или отсутствие прав доступа к БД. Всегда проверяйте логи (`keycloak.log`) для диагностики.

## Управление пользователями

Управление пользователями в Keycloak — одна из ключевых задач администратора, включающая создание, настройку и удаление учетных записей, а также управление их атрибутами и ролями. Таблица ниже предоставляет полный набор команд для работы с пользователями через Admin CLI (`kcadm.sh`), включая примеры, возможные ошибки и их решения. Эти команды позволяют автоматизировать процессы, такие как массовая регистрация пользователей или изменение паролей, и обеспечивают гибкость при интеграции с внешними системами. Таблица также учитывает различия в поведении команд на разных платформах и их влияние на безопасность и производительность системы.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `kcadm.sh create users` | Создание пользователя | `-r` — realm<br>`-s` — атрибуты (username, email, enabled) | ```bash<br># Создание пользователя<br>./kcadm.sh create users -r myrealm -s username=user1 -s email=user1@example.com -s enabled=true<br>```<br>```bash<br># Создание с паролем<br>./kcadm.sh create users -r myrealm -s username=user2 -s enabled=true -s password=secure123<br>``` | **Ошибка**: "User already exists"<br>**Решение**: Проверить уникальность имени.<br>**Ошибка**: "Invalid email"<br>**Решение**: Указать корректный email. | Добавляет пользователя в realm, влияет на объем данных. | Взаимодействует с ролями и клиентами. |
| `kcadm.sh update users` | Обновление пользователя | `-r` — realm<br>`-s` — обновляемые атрибуты | ```bash<br># Обновление email<br>./kcadm.sh update users/user1 -r myrealm -s email=newemail@example.com<br>``` | **Ошибка**: "User not found"<br>**Решение**: Проверить ID или имя пользователя. | Изменяет данные, может повлиять на доступ. | Связан с токенами и ролями. |
| `kcadm.sh delete users` | Удаление пользователя | `-r` — realm<br>`-id` — ID пользователя | ```bash<br># Удаление пользователя<br>./kcadm.sh delete users/user1 -r myrealm<br>``` | **Ошибка**: "User not found"<br>**Решение**: Проверить ID. | Удаляет доступ пользователя. | Может повлиять на логи аудита. |

**Важно запомнить**: Всегда указывайте `-r` для конкретного realm. Пароли должны соответствовать политике безопасности.

**Типичные ошибки**: Неправильный realm или отсутствие прав у администратора. Используйте `kcadm.sh config credentials` для аутентификации.

## Управление ролями и клиентами

Роли и клиенты в Keycloak определяют доступ пользователей к приложениям. Таблица ниже описывает команды для создания и настройки ролей и клиентов, включая параметры, примеры и возможные ошибки. Эти команды необходимы для управления доступом и интеграции Keycloak с внешними сервисами, такими как веб-приложения или API. Таблица учитывает продвинутые сценарии, такие как настройка scope и протоколов, а также влияние изменений на безопасность и производительность системы.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `kcadm.sh create roles` | Создание роли | `-r` — realm<br>`-s` — имя и атрибуты роли | ```bash<br># Создание роли<br>./kcadm.sh create roles -r myrealm -s name=editor -s description="Editor role"<br>``` | **Ошибка**: "Role already exists"<br>**Решение**: Проверить уникальность имени. | Добавляет роль, влияет на авторизацию. | Связана с пользователями и клиентами. |
| `kcadm.sh create clients` | Создание клиента | `-r` — realm<br>`-s` — атрибуты (clientId, protocol) | ```bash<br># Создание клиента<br>./kcadm.sh create clients -r myrealm -s clientId=myapp -s protocol=openid-connect<br>``` | **Ошибка**: "Client already exists"<br>**Решение**: Указать уникальный clientId. | Регистрирует приложение в Keycloak. | Влияет на токены и SSO. |
| `kcadm.sh add-roles` | Назначение роли | `--uusername` — имя пользователя<br>`--rolename` — имя роли | ```bash<br># Назначение роли<br>./kcadm.sh add-roles -r myrealm --uusername=user1 --rolename=editor<br>``` | **Ошибка**: "Role not found"<br>**Решение**: Проверить имя роли. | Изменяет доступ пользователя. | Влияет на токены и клиентов. |

**Важно запомнить**: Клиенты должны использовать уникальный `clientId`. Роли определяют доступ к ресурсам.

**Типичные ошибки**: Неправильная настройка протокола клиента или отсутствие redirect URI. Проверяйте настройки в консоли.

## Интеграция и безопасность

Интеграция Keycloak с внешними системами и настройка безопасности — важные аспекты для обеспечения надежной аутентификации и авторизации. Таблица ниже описывает команды и параметры для настройки Identity Providers, токенов и политик безопасности. Эти настройки позволяют интегрировать Keycloak с LDAP, SAML или социальными сетями, а также защищать систему от атак. Таблица включает продвинутые сценарии, такие как настройка MFA и управление токенами, а также рекомендации по оптимизации.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `kcadm.sh create identity-provider/instances` | Создание IdP | `-r` — realm<br>`-s` — атрибуты (alias, providerId) | ```bash<br># Создание Google IdP<br>./kcadm.sh create identity-provider/instances -r myrealm -s alias=google -s providerId=google<br>``` | **Ошибка**: "Invalid providerId"<br>**Решение**: Проверить доступные провайдеры. | Добавляет внешнюю аутентификацию. | Влияет на пользователей и токены. |
| `kcadm.sh update authentication/flows` | Настройка MFA | `-r` — realm<br>`-s` — параметры потока | ```bash<br># Включение MFA<br>./kcadm.sh update authentication/flows/browser -r myrealm -s requirement=ALTERNATIVE<br>``` | **Ошибка**: "Flow not found"<br>**Решение**: Проверить имя потока. | Усиливает безопасность. | Влияет на процесс входа. |
| `kcadm.sh update realms` | Настройка политик паролей | `-r` — realm<br>`-s` — атрибуты политики | ```bash<br># Установка политики паролей<br>./kcadm.sh update realms/myrealm -s passwordPolicy="length(8) and specialChars(1)"<br>``` | **Ошибка**: "Invalid policy"<br>**Решение**: Проверить синтаксис политики. | Усиливает безопасность паролей. | Влияет на пользователей. |

**Важно запомнить**: MFA требует дополнительных настроек клиента. Используйте HTTPS в продакшене.

**Типичные ошибки**: Неправильная настройка IdP или отсутствие клиентских секретов. Проверяйте логи и документацию провайдера.

## Автоматизация и оптимизация

Автоматизация задач в Keycloak упрощает управление и повышает эффективность. Таблица ниже описывает команды и скрипты для автоматизации создания пользователей, резервного копирования и оптимизации производительности. Эти команды полезны для массовых операций и интеграции с CI/CD. Таблица включает примеры скриптов, возможные ошибки и рекомендации по оптимизации для разных окружений.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `kcadm.sh create users` | Массовая регистрация | `-r` — realm<br>`-f` — файл с данными | ```bash<br># Массовая регистрация<br>./kcadm.sh create users -r myrealm -f users.json<br>``` | **Ошибка**: "Invalid JSON"<br>**Решение**: Проверить формат файла. | Автоматизирует создание пользователей. | Влияет на объем данных. |
| `./kc.sh export` | Экспорт realm | `--dir` — директория<br>`--realm` — имя realm | ```bash<br># Экспорт realm<br>./kc.sh export --dir /backup --realm myrealm<br>``` | **Ошибка**: "Export failed"<br>**Решение**: Проверить права доступа к директории. | Создает резервную копию. | Взаимодействует с файловой системой. |
| `./kc.sh start` | Оптимизация запуска | `--cache` — тип кэша<br>`--optimized` — режим продакшена | ```bash<br># Оптимизированный запуск<br>./kc.sh start --optimized --cache=ispn<br>``` | **Ошибка**: "Cache not available"<br>**Решение**: Установить Infinispan. | Ускоряет работу сервера. | Влияет на производительность. |

**Важно запомнить**: Используйте JSON для массовых операций. Резервное копирование обязательно в продакшене.

**Типичные ошибки**: Неправильный формат входных данных или недостаток ресурсов. Проверяйте логи и права доступа.

## Справочник параметров конфигурации

```bash
# Запуск сервера с PostgreSQL
./kc.sh start --db=postgres --db-url=jdbc:postgresql://localhost:5432/keycloak --db-username=keycloak --db-password=securepass

# Оптимизированный запуск для продакшена
./kc.sh start --optimized --http-port=8080 --cache=ispn

# Создание администратора
./kc.sh config --admin-username=admin --admin-password=securepass

# Экспорт realm
./kc.sh export --dir /backup --realm myrealm

# Импорт realm
./kc.sh import --dir /backup --realm myrealm

# Настройка HTTPS
./kc.sh start --https-key-store-file=/path/to/keystore --https-key-store-password=securepass
```
