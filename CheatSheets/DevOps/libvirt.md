<xaiArtifact>

# Подробное руководство по libvirt для начинающих

## Содержание

1.  [Термины и определения](#термины-и-определения)
2.  [Установка и начальная настройка](#установка-и-начальная-настройка)
3.  [Управление жизненным циклом виртуальных машин](#управление-жизненным-циклом-виртуальных-машин)
4.  [Сетевые настройки](#сетевые-настройки)
5.  [Управление хранилищами](#управление-хранилищами)
6.  [Работа с гостевыми ОС и мониторинг](#работа-с-гостевыми-ос-и-мониторинг)
7.  [Автоматизация и расширенные сценарии](#автоматизация-и-расширенные-сценарии)
8.  [Приложение: Полный справочник команд и конфигураций](#приложение-полный-справочник-команд-и-конфигураций)

## Термины и определения

Перед началом работы важно понять базовую терминологию, используемую в экосистеме libvirt. Эта таблица дает развернутые объяснения ключевых концепций и жаргонизмов, которые будут постоянно встречаться в руководстве. Понимание этих терминов необходимо для эффективного использования всех последующих таблиц с командами и конфигурациями.

| Термин | Объяснение |
| :--- | :--- |
| **Libvirt** | Это не гипервизор, а набор инструментов и API-интерфейсов для единообразного управления различными технологиями виртуализации. Он предоставляет общий слой абстракции, позволяя использовать одни и те же команды для управления виртуальными машинами под управлением KVM, Xen, VirtualBox и других. Думайте о нем как о "драйвере" или "универсальном пульте" для гипервизоров. |
| **Гипервизор (Hypervisor)** | Программа или аппаратная платформа, которая позволяет запускать несколько операционных систем на одном физическом хосте. В контексте libvirt чаще всего используется KVM (Kernel-based Virtual Machine) в Linux. Гипервизор напрямую управляет доступом виртуальных машин к физическим ресурсам процессора и памяти. |
| **Домен (Domain)** | Основной термин libvirt для виртуальной машины. Когда в документации или командах упоминается "домен", имеется в виду экземпляр виртуальной машины. Это может быть как работающая, так и остановленная ВМ. |
| **KVM (Kernel-based Virtual Machine)** | Гипервизор, встроенный непосредственно в ядро Linux. Он превращает ядро Linux в гипервизор, используя расширения виртуализации современных процессоров (Intel VT-x или AMD-V). KVM является наиболее производительным и распространенным бэкендом для libvirt в Linux. |
| **QEMU (Quick Emulator)** | Универсальный эмулятор и виртуализатор с открытым исходным кодом. В связке с KVM (часто пишут "KVM/QEMU") QEMU обеспечивает эмуляцию устройств (сетевых карт, дисков, видеоадаптеров), в то время как KVM берет на себя выполнение процессорных инструкций. |
| **Хост (Host)** | Физический сервер или компьютер, на котором установлен гипервизор и запускаются виртуальные машины. Это основная, "реальная" операционная система, управляющая всеми ресурсами. |
| **Гостевая ОС (Guest OS)** | Операционная система, которая работает внутри виртуальной машины (домена). Она "гостит" на хосте и использует предоставленные ей виртуальные ресурсы. |
| **Демон libvirt (libvirtd)** | Фоновая служба (демон), которая обрабатывает все запросы на управление. Клиентские утилиты, такие как `virsh`, взаимодействуют с этим демоном для выполнения команд. Он должен быть всегда запущен для работы libvirt. |
| **Virsh** | Основная консольная утилита для управления libvirt. Позволяет запускать, останавливать, настраивать и мониторить домены, сети и хранилища с помощью командной строки. Это "швейцарский нож" администратора. |
| **Виртуальная сеть (Virtual Network)** | Изолированный или подключенный к физической сети сегмент, который используют виртуальные машины для взаимодействия друг с другом и с внешним миром. По умолчанию libvirt создает сеть `default` в режиме NAT. |
| **Пулы хранилищ (Storage Pools)** | Абстракция, представляющая собой источник места для хранения образов дисков виртуальных машин. Это может быть директория на локальном диске (`dir`), логический том LVM (`logical`), сетевая файловая система (`netfs`) и др. Пул содержит в себе **тома (volumes)**. |
| **Тома (Storage Volumes)** | Конкретные файлы или блочные устройства, которые используются виртуальными машинами в качестве их виртуальных дисков. В контексте пула типа `dir` том — это обычный файл (например, `ubuntu-vm.qcow2`). |
| **XML-конфигурация** | Каждый домен, сеть или пул хранилищ в libvirt описывается XML-файлом. Этот файл определяет все атрибуты: объем памяти, количество CPU, сетевые интерфейсы, диски и т.д. Команды `virsh edit` или `virsh dumpxml` работают с этими конфигурациями. |
| **Snapshot (Снимок состояния)** | Копия состояния и данных виртуальной машины в определенный момент времени. Позволяет "откатиться" к этому состоянию в будущем. Бывают внутренние (хранятся внутри qcow2 диска) и внешние (отдельные файлы). |

## Установка и начальная настройка

Перед использованием libvirt необходимо установить соответствующие пакеты и провести базовую настройку среды. Данный раздел охватывает установку на различных дистрибутивах Linux, запуск и проверку работоспособности демона `libvirtd`, а также настройку прав доступа для непривилегированных пользователей. Правильная начальная конфигурация является залогом стабильной работы всей системы виртуализации.

| Компонент / Действие | Назначение | Параметры / Команды | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Установка пакетов (Debian/Ubuntu)** | Установка стека KVM/QEMU и утилит libvirt. | `sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virt-manager` | ```bash<br># Базовая установка<br>sudo apt update<br>sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients<br><br># Установка с GUI-менеджером<br>sudo apt install virt-manager<br>``` | **Ошибка:** "Failed to connect socket... Permission denied". <br> **Решение:** Добавить пользователя в группы `libvirt` и `kvm`: `sudo usermod -aG libvirt,kvm $USER`. Перелогиньтесь. | Устанавливает демоны, библиотеки и CLI-утилиты. Создает служебные директории в `/var/lib/libvirt/`. | Интегрируется с ядром через модуль `kvm`. Требует поддержки виртуализации CPU. |
| **Установка пакетов (RHEL/CentOS/Fedora)** | Установка стека виртуализации в Red Hat- based системах. | `sudo dnf install @virtualization` | ```bash<br># Установка группы пакетов (Fedora/RHEL9+)<br>sudo dnf install @virtualization<br><br># Альтернатива для CentOS 7 / RHEL 8<br>sudo yum install qemu-kvm libvirt libvirt-python libguestfs-tools virt-install<br>``` | **Ошибка:** "Could not open /dev/kvm". <br> **Решение:** Проверить, что в BIOS включена виртуализация (Intel VT-x/AMD-V). Проверить загружен ли модуль ядра: `lsmod \| grep kvm`. | Аналогично Debian. Может потребоваться отключить/остановить другие гипервизоры (например, VirtualBox). | Зависит от `qemu`, использует `systemd` для управления демоном. |
| **Запуск и проверка демона** | Активация фоновой службы libvirt для обработки команд. | `sudo systemctl <start/stop/status/enable> libvirtd` | ```bash<br># Запуск и добавление в автозагрузку<br>sudo systemctl enable --now libvirtd<br><br># Проверка статуса<br>sudo systemctl status libvirtd<br><br># Проверка подключения<br>virsh connect<br>``` | **Ошибка:** Демон не запускается из-за конфликта портов. <br> **Решение:** Проверить, не запущены ли другие экземпляры `libvirtd` или `virtlogd`. Использовать `sudo systemctl restart libvirtd`. | Демон прослушивает UNIX-сокет (`/var/run/libvirt/libvirt-sock`). Открывает порты для удаленного управления, если настроено. | Все клиенты (`virsh`, `virt-manager`) взаимодействуют с системой через этот демон. |
| **Настройка прав пользователя** | Предоставление обычному пользователю прав на управление ВМ без sudo. | Добавление пользователя в группы `libvirt` и `kvm`. | ```bash<br># Добавление текущего пользователя в группы<br>sudo usermod -aG libvirt,kvm $USER<br><br># Проверка членства в группах<br>groups $USER<br>``` | **Ошибка:** Пользователь в группах, но права не применяются. <br> **Решение:** Необходимо выйти из системы и зайти заново или выполнить `newgrp libvirt`. | Пользователь получает возможность управлять ВМ, но только своими, если не используется привилегированный режим. | Определяет, к каким ресурсам (каким ВМ, сетевым конфигурациям) имеет доступ пользователь. |

## Управление жизненным циклом виртуальных машин

Это ядро руководства, описывающее полный цикл существования виртуальной машины: от создания и запуска до остановки, приостановки и удаления. Таблица ниже содержит исчерпывающий набор команд `virsh` для выполнения этих операций. Понимание этих команд является критически важным для повседневного администрирования, так как они позволяют контролировать состояние и ресурсы доменов.

| Команда | Назначение | Параметры (ключевые) | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **`virsh list`** | Просмотр списка доменов. | `--all` (все ВМ), `--inactive` (только выключенные) | ```bash<br># Список только работающих ВМ<br>virsh list<br><br># Полный список всех ВМ<br>virsh list --all<br>``` | **Ошибка:** "Failed to connect to hypervisor". <br> **Решение:** Убедиться, что демон `libvirtd` запущен и пользователь имеет права доступа. | Минимальная нагрузка. Запрашивает состояние у демона. | Отображает домены, доступные для текущего подключения (например, `qemu:///system`). |
| **`virsh start`** | Запуск остановленной ВМ. | `<domain-name-or-uuid>` | ```bash<br># Запуск ВМ с именем 'ubuntu-vm'<br>virsh start ubuntu-vm<br><br># Запуск по UUID (можно взять из virsh dumpxml)<br>virsh start 12345678-1234-...</br>``` | **Ошибка:** "error: Failed to start domain: internal error: process exited while connecting to monitor". <br> **Решение:** Часто проблема с конфигурацией диска или сети. Проверить путь к диску (`virsh edit ubuntu-vm`) и доступность сетевого моста. | Выделяет оперативную память, создает процессы QEMU, нагружает CPU и I/O при старте гостевой ОС. | Использует ресурсы, определенные в XML-конфигурации ВМ (CPU, память, диски, сеть). |
| **`virsh shutdown`** | Корректное выключение ВМ (через ACPI). | `<domain-name-or-uuid>` `--mode acpi` | ```bash<br># Корректное выключение ВМ<br>virsh shutdown ubuntu-vm<br><br># Принудительное указание режима<br>virsh shutdown ubuntu-vm --mode acpi<br>``` | **Ошибка:** ВМ не выключается (гостевая ОС не реагирует на ACPI). <br> **Решение:** Использовать `virsh destroy` как последнее средство (риск потери данных). | Дает гостевой ОС время на корректное завершение работы процессов и файловых систем. | Требует установленного и работающего в гостевой ОС драйвера ACPI. |
| **`virsh destroy`** | Немедленная остановка ВМ (аналог "выдернуть шнур"). | `<domain-name-or-uuid>` | ```bash<br># Аварийное выключение ВМ 'test-vm'<br>virsh destroy test-vm<br>``` | **Ошибка:** После `destroy` ВМ остается в списке как "выключенная". Это нормально. Состояние просто меняется на `shut off`. | Может привести к потере несохраненных данных в гостевой ОС, повреждению файловых систем. | Не взаимодействует с гостевой ОС. Процесс QEMU принудительно завершается. |
| **`virsh suspend` / `virsh resume`** | Приостановка (состояние сна) и возобновление работы ВМ. | `<domain-name-or-uuid>` | ```bash<br># Приостановка ВМ<br>virsh suspend ubuntu-vm<br><br># Возобновление работы<br>virsh resume ubuntu-vm<br>``` | **Ошибка:** После suspend/resume сетевое соединение внутри ВМ может "отвалиться". <br> **Решение:** Перезапустить сетевой сервис внутри гостевой ОС или перезапустить сетевой интерфейс ВМ через `virsh`. | Состояние ВМ сохраняется в оперативной памяти хоста. CPU не используется, память занята. | Полезно для кратковременной экономии ресурсов CPU. Не освобождает оперативную память. |
| **`virsh reboot`** | Перезагрузка ВМ. | `<domain-name-or-uuid>` | ```bash<br># Перезагрузка ВМ<br>virsh reboot ubuntu-vm<br>``` | Аналогична `virsh shutdown` — требует корректной работы ACPI в гостевой ОС. | Эквивалентна последовательному `shutdown` и `start`. | |
| **`virsh undefine`** | Удаление конфигурации ВМ из libvirt. | `<domain-name-or-uuid>` `--remove-all-storage` (удалить и диски) `--snapshots-metadata` (удалить снимки) | ```bash<br># Удалить только конфигурацию ВМ (диски останутся)<br>virsh undefine ubuntu-vm<br><br># Удалить ВМ вместе со всеми ее дисками<br>virsh undefine ubuntu-vm --remove-all-storage<br>``` | **Ошибка:** Нельзя удалить работающую ВМ. <br> **Решение:** Сначала выполнить `virsh destroy ubuntu-vm`. | Удаляет XML-файл конфигурации ВМ. Дисковые образы физически не удаляются, если не использован флаг `--remove-all-storage`. | Окончательно удаляет ВМ из списка `virsh list --all`. Без флага удаления дисков они становятся "осиротевшими". |
| **`virsh dumpxml`** | Просмотр XML-конфигурации ВМ. | `<domain-name-or-uuid>` | ```bash<br># Вывести конфигурацию в stdout<br>virsh dumpxml ubuntu-vm<br><br># Сохранить конфигурацию в файл для бэкапа<br>virsh dumpxml ubuntu-vm > ubuntu-vm-backup.xml<br>``` | **Ошибка:** "error: failed to get domain". <br> **Решение:** Убедиться, что ВМ существует и ее имя введено верно. Использовать `virsh list --all`. | Не влияет на состояние ВМ. Позволяет провести аудит конфигурации или создать шаблон для новой ВМ. | Показывает актуальную конфигурацию, включая автоматически добавленные libvirt элементы (например, QEMU-эмулятор). |
| **`virsh edit`** | Редактирование XML-конфигурации ВМ в текстовом редакторе. | `<domain-name-or-uuid>` | ```bash<br># Открыть конфигурацию ВМ для редактирования<br>virsh edit ubuntu-vm<br>``` | **Ошибка:** После сохранения "error: XML error: ...". <br> **Решение:** Допущена синтаксическая ошибка в XML. Проверить закрытие тегов, правильность атрибутов. Редактор не дает сохранить файл с ошибкой, но иногда это возможно. | Изменения вступают в силу после следующего запуска ВМ (если не касаются "живых" настроек, которые можно менять на лету). | Прямое редактирование XML — мощный, но рискованный метод. Всегда делайте бэкап через `dumpxml` перед редактированием. |
| **`virsh console`** | Подключение к текстовой консоли ВМ. | `<domain-name-or-uuid>` | ```bash<br># Подключиться к консоли ВМ 'ubuntu-vm'<br>virsh console ubuntu-vm<br><br># Выйти из консоли: Ctrl + ]</br>``` | **Ошибка:** "error: internal error: cannot find character device <pty...>" или черный экран. <br> **Решение:** В гостевой ОС Linux необходимо настроить последовательную консоль, добавив в загрузчик параметры `console=ttyS0` и запустив сервис `getty@ttyS0`. | Обеспечивает доступ к ВМ, даже если сетевое подключение недоступно. | Работает через виртуальную последовательную консоль (serial console), эмулируемую QEMU. |

## Сетевые настройки

Сети в libvirt обеспечивают связность виртуальных машин между собой и с внешним миром. Данный раздел посвящен управлению виртуальными сетями, их конфигурации и диагностике. Понимание различных типов сетей (NAT, Isolated, Bridge) является ключевым для построения требуемой сетевой топологии и обеспечения безопасности виртуальной инфраструктуры.

| Команда / Концепция | Назначение | Параметры / Конфигурация | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **`virsh net-list`** | Просмотр списка доступных виртуальных сетей. | `--all` (все сети) | ```bash<br># Список активных сетей<br>virsh net-list<br><br># Полный список<br>virsh net-list --all<br>``` | **Ошибка:** Сеть есть в списке, но ВМ не могут получить IP. <br> **Решение:** Убедиться, что сеть запущена (`virsh net-info <network-name>`). Запустить её: `virsh net-start <network-name>`. | Показывает сети, управляемые демоном libvirt. | Сети могут быть активны, но не использоваться ни одной ВМ. |
| **`virsh net-info`** | Просмотр информации о конкретной сети. | `<network-name>` | ```bash<br># Информация о сети 'default'<br>virsh net-info default<br>``` | **Ошибка:** "error: failed to get network 'default'". <br> **Решение:** Сеть не определена. Определить её из встроенного шаблона: `virsh net-define /usr/share/libvirt/networks/default.xml`. | Показывает базовые параметры: UUID, состояние, тип моста (bridge) и т.д. | |
| **Типы сетей: NAT** | Режим по умолчанию. ВМ получают доступ наружу через NAT, но недоступны снаружи. | Определяется в XML. `<forward mode='nat'>` | *См. пример в `virsh net-dumpxml`* | **Особенность:** ВМ в сети NAT "видят" друг друга, но с хоста и извне доступа к ним нет по IP. Для доступа нужно пробрасывать порты. | Создает на хосте виртуальный мост (обычно `virbr0`) и запускает `dnsmasq` для раздачи IP по DHCP. | Идеально для изолированных сред разработки и тестирования. |
| **Типы сетей: Isolated** | Полностью изолированная сеть. ВМ общаются только друг с другом, выхода вовне нет. | `<forward mode='none'/>` или отсутствие тега `<forward>`. | *См. пример в `virsh net-dumpxml`* | **Особенность:** Абсолютная изоляция. Полезно для моделирования изолированных стендов безопасности. | Аналогично NAT, но без правил iptables/nftables для маршрутизации наружу. | |
| **Типы сетей: Bridge (Мост)** | ВМ подключаются напрямую к физической сети хоста, получая IP из той же подсети. | Создается мостовой интерфейс (напр., `br0`), в который включается физический интерфейс хоста (напр., `eth0`). | ```xml<br><!-- Фрагмент XML ВМ --><br><interface type='bridge'><br>  <mac address='52:54:00:xx:xx:xx'/><br>  <source bridge='br0'/><br>  <model type='virtio'/><br></interface><br>``` | **Ошибка:** ВМ не получает сетевой доступ после подключения к мосту. <br> **Решение:** Убедиться, что физический интерфейс (`eth0`) НЕ имеет своего IP, а IP назначен мосту (`br0`). Проверить firewall на хосте. | Позволяет ВМ быть полноправными участниками сети, как физические машины. Требует ручной настройки на хосте. | Наилучшая производительность. Используется для серверных ВМ, которым нужен статический публичный IP. |
| **`virsh net-dumpxml`** | Просмотр конфигурации виртуальной сети. | `<network-name>` | ```bash<br># Посмотреть конфигурацию сети 'default'<br>virsh net-dumpxml default<br>``` | | Показывает диапазон IP, DHCP-настройки, форвардинг. | Полезно для создания бэкапа сетевой конфигурации или её клонирования. |
| **`virsh net-edit`** | Редактирование конфигурации сети. | `<network-name>` | ```bash<br># Изменить диапазон DHCP в сети 'default'<br>virsh net-edit default<br>``` | **Ошибка:** Изменения не применяются к уже работающим ВМ. <br> **Решение:** Перезапустить сеть (`virsh net-destroy default && virsh net-start default`). ВМ потеряют сетевое подключение на время. | Изменения вступят в силу после перезапуска сети. | Аналогично `virsh edit`, но для сетей. |
| **`virsh net-start` / `virsh net-destroy`** | Запуск и остановка виртуальной сети. | `<network-name>` | ```bash<br># Остановить сеть 'default'<br>virsh net-destroy default<br><br># Запустить сеть 'default'<br>virsh net-start default<br>``` | **Ошибка:** Нельзя уничтожить сеть, которую используют работающие ВМ. <br> **Решение:** Сначала отключить сеть у ВМ или остановить ВМ. | Создает/удаляет сетевой мост и запускает/останавливает `dnsmasq`. | Остановка сети обрывает сетевое соединение у всех подключенных к ней ВМ. |

## Управление хранилищами

Система хранилищ libvirt абстрагирует физические носители данных в "пулы" и "тома", что упрощает управление дисковым пространством для виртуальных машин. Этот раздел объясняет, как создавать пулы хранилищ (например, директории или LVM-группы), управлять томами (виртуальными дисками) и подключать их к ВМ. Эффективное управление хранилищами напрямую влияет на производительность и надежность виртуальной среды.

| Команда / Концепция | Назначение | Параметры / Конфигурация | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **`virsh pool-list`** | Просмотр списка пулов хранилищ. | `--all` (все пулы), `--details` (подробно) | ```bash<br># Список активных пулов<br>virsh pool-list<br><br># Подробный список всех пулов<br>virsh pool-list --all --details<br>``` | **Ошибка:** Пул в состоянии `inactive`. <br> **Решение:** Активировать пул: `virsh pool-start <pool-name>`. | Показывает доступные источники хранения данных для ВМ. | Пул должен быть активен, чтобы создавать в нем тома или запускать ВМ, которые их используют. |
| **`virsh pool-info`** | Информация о конкретном пуле. | `<pool-name>` | ```bash<br># Информация о пуле 'default'<br>virsh pool-info default<br>``` | | Показывает тип пула, путь к нему, состояние и объем использования. | |
| **Типы пулов: `dir`** | Простая директория на файловой системе хоста. | Тип: `dir`. Путь: `<path>` | ```bash<br># Создать пул типа 'dir'<br>virsh pool-define-as mydir-pool dir - - - - "/mnt/vm-storage"<br>virsh pool-build mydir-pool<br>virsh pool-start mydir-pool<br>virsh pool-autostart mydir-pool<br>``` | **Ошибка:** "error: cannot create directory... Permission denied". <br> **Решение:** Убедиться, что пользователь `libvirt-qemu` (или `root`) имеет права на запись в указанную директорию. | Создает директорию, если её нет (с `pool-build`). Файлы томов — это обычные файлы в этой директории. | Наиболее простой и распространенный тип. Подходит для большинства сценариев. |
| **Типы пулов: `logical`** | Пул на основе LVM (Logical Volume Manager). | Тип: `logical`. Источник: LVM Volume Group. | ```bash<br># Создать пул на VG 'vg-vms'<br>virsh pool-define-as mylvm-pool logical - - "/dev/vg-vms" - -<br>virsh pool-start mylvm-pool<br>``` | **Ошибка:** "error: storage pool is not active". <br> **Решение:** Убедиться, что LVM Volume Group существует и доступна. | Позволяет создавать тома как LVM Logical Volumes. Высокая производительность. | Требует предварительно настроенной LVM-инфраструктуры. |
| **`virsh vol-list`** | Просмотр списка томов в пуле. | `<pool-name>` | ```bash<br># Список томов в пуле 'default'<br>virsh vol-list default<br>``` | **Ошибка:** "error: storage pool is not active". <br> **Решение:** Активировать пул с помощью `virsh pool-start`. | Показывает файлы дисков или LV, которые можно подключить к ВМ. | |
| **`virsh vol-create`** / **`virsh vol-create-as`** | Создание нового тома (виртуального диска). | `vol-create-as <pool> <name> <capacity> --format <qcow2/raw>` | ```bash<br># Создать том размером 20ГБ в формате qcow2 в пуле 'default'<br>virsh vol-create-as default my-new-disk.qcow2 20G --format qcow2<br><br># Создать RAW-диск 10ГБ<br>virsh vol-create-as default my-raw-disk.raw 10G --format raw<br>``` | **Ошибка:** "error: cannot create vol... no space left on device". <br> **Решение:** Проверить свободное место в пуле (`virsh pool-info <pool-name>`). Использовать `qemu-img` для создания разреженных (sparse) файлов. | Создает физический файл на диске или LV. Формат `qcow2` поддерживает снимки и занимает меньше места. | Том должен быть создан перед тем, как на него можно сослаться в XML-конфигурации ВМ. |
| **`virsh vol-delete`** | Удаление тома. | `<vol-name> --pool <pool-name>` | ```bash<br># Удалить том из пула 'default'<br>virsh vol-delete my-old-disk.qcow2 --pool default<br>``` | **Ошибка:** Нельзя удалить том, используемый работающей ВМ. <br> **Решение:** Остановить ВМ или отключить диск через `virsh detach-disk`. | Физически удаляет файл диска. Данные безвозвратно теряются. | Критически важная операция. Всегда проверяйте, что том не используется. |
| **`virsh attach-disk`** / **`virsh detach-disk`** | Горячее подключение/отключение диска к/от работающей ВМ. | `attach-disk <domain> <source> <target> --subdriver <format> --persistent` | ```bash<br># Подключить диск к работающей ВМ как vdb<br>virsh attach-disk ubuntu-vm /path/to/disk.qcow2 vdb --persistent<br><br># Отключить диск vdb от ВМ<br>virsh detach-disk ubuntu-vm vdb<br>``` | **Ошибка:** "error: Failed to attach disk". <br> **Решение:** Убедиться, что путь к источнику (`source`) корректен и формат указан верно. Проверить, не подключен ли уже целевой диск (`target`). | Позволяет расширять хранилище или подключать резервные диски без перезагрузки ВМ. Флаг `--persistent` записывает изменение в XML-конфиг. | В гостевой ОС может потребоваться просканировать новые SCSI-устройства или отмонтировать диск перед отключением. |

## Работа с гостевыми ОС и мониторинг

Для эффективного администрирования необходимо не только управлять самой ВМ, но и взаимодействовать с гостевой операционной системой, а также отслеживать потребление ресурсов. Данный раздел охватывает инструменты для мониторинга производительности, внедрения гостевых агентов для улучшения взаимодействия, а также создания и управления снимками состояния ВМ.

| Команда / Концепция | Назначение | Параметры / Конфигурация | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **`virsh domstats`** | Получение статистики по доменам в реальном времени. | `<domain>` или `--all` | ```bash<br># Статистика по всем ВМ<br>virsh domstats --all<br><br># Статистика по конкретной ВМ<br>virsh domstats ubuntu-vm<br>``` | **Ошибка:** Статистика по CPU показывает 100% постоянно. <br> **Решение:** Это может быть нормально для нагруженной ВМ. Используйте `virsh vcpuinfo` для деталей по каждому vCPU. | Показывает использование CPU, памяти, дискового I/O и сетевого трафика. Не требует установки гостевых агентов. | Источник данных — гипервизор (KVM), поэтому статистика точна, но не всегда детализирована на уровне процессов гостевой ОС. |
| **`virsh vcpuinfo`** | Информация о виртуальных процессорах (vCPU) ВМ. | `<domain>` | ```bash<br># Показать информацию о vCPU ВМ 'ubuntu-vm'<br>virsh vcpuinfo ubuntu-vm<br>``` | **Ошибка:** vCPU "застревают" на одном физическом CPU (pCPU). <br> **Решение:** Настроить привязку vCPU к pCPU (pinning) для улучшения производительности в NUMA-системах. | Показывает состояние каждого vCPU (работает/остановлен), время работы, на каком физическом ядре выполняется. | Полезно для диагностики проблем с производительностью и планировщиком CPU. |
| **Гостевой агент (QEMU GA)** | Служба внутри гостевой ОС, обеспечивающая улучшенное взаимодействие с хостом. | Установка пакета `qemu-guest-agent` в гостевой ОС. | ```bash<br># Установка в гостевой Ubuntu/Debian<br>sudo apt install qemu-guest-agent<br>sudo systemctl start qemu-guest-agent<br><br># Проверка с хоста<br>virsh qemu-agent-command ubuntu-vm '{"execute":"guest-info"}'<br>``` | **Ошибка:** Команды агента не работают. <br> **Решение:** Убедиться, что в XML-конфиге ВМ добавлен канал для агента (`<channel type='unix'>`). Агент должен быть запущен внутри гостя. | Позволяет выполнять команды внутри гостя, получать IP-адреса, инициировать `shutdown`/`reboot` изнутри. | Требует настройки как на хосте (XML), так и в гостевой ОС (установка пакета). |
| **`virsh snapshot-*`** | Управление снимками состояния ВМ. | `snapshot-create-as <domain> <name> [--disk-only]` `snapshot-list <domain>` `snapshot-revert <domain> <name>` | ```bash<br># Создать снимок с именем 'before-update'<br>virsh snapshot-create-as ubuntu-vm before-update<br><br># Список снимков ВМ<br>virsh snapshot-list ubuntu-vm<br><br># Откатиться к снимку<br>virsh snapshot-revert ubuntu-vm before-update<br>``` | **Ошибка:** "unsupported configuration: internal snapshot for disk ... not supported for this storage type". <br> **Решение:** Для дисков в формате `raw` или некоторых сетевых хранилищ внутренние снимки невозможны. Используйте `--disk-only` для создания внешних снимков. | Снимок сохраняет состояние памяти и дисков ВМ. Создание снимка может "заморозить" ВМ на несколько секунд. Внутренние снимки увеличивают размер qcow2-файла. | **Внимание!** Откат к снимку, сделанному давно, может привести к потере данных, созданных после этого снимка. Всегда делайте бэкапы. |

## Автоматизация и расширенные сценарии

Libvirt предоставляет мощные средства для автоматизации задач управления виртуальной инфраструктурой, включая создание ВМ из командной строки, использование шаблонов конфигураций и настройку автостарта. Этот раздел предназначен для пользователей, которые хотят выйти за рамки базовых операций и настроить управляемую, предсказуемую среду виртуализации.

| Команда / Концепция | Назначение | Параметры / Конфигурация | Примеры | Ошибки и решения | Влияние на систему | Взаимодействие |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **`virt-install`** | Утилита для создания и установки новой ВМ из командной строки. | `--name`, `--ram`, `--vcpus`, `--disk`, `--cdrom`, `--os-variant`, `--network` | ```bash<br># Создать ВМ с 2ГБ ОЗУ, 2 vCPU, из ISO-образа<br>virt-install \<br>  --name new-vm \<br>  --ram 2048 \<br>  --vcpus 2 \<br>  --disk size=20,format=qcow2 \<br>  --cdrom /path/to/ubuntu.iso \<br>  --os-variant ubuntu20.04 \<br>  --network network=default<br>``` | **Ошибка:** "ERROR unable to connect to graphical console...". <br> **Решение:** Использовать флаг `--noautoconsole` и потом подключиться через `virsh console` или VNC. Или запускать команду из графической сессии. | Автоматически генерирует XML-конфигурацию, создает дисковый том и запускает ВМ. | Основной инструмент для автоматического развертывания ВМ. Параметр `--os-variant` помогает оптимизировать конфигурацию для конкретной ОС. |
| **Автозапуск ВМ (`autostart`)** | Настройка ВМ для автоматического запуска при загрузке хоста. | `virsh autostart <domain> [--disable]` | ```bash<br># Включить автозапуск для ВМ 'ubuntu-vm'<br>virsh autostart ubuntu-vm<br><br># Отключить автозапуск<br>virsh autostart ubuntu-vm --disable<br>``` | **Ошибка:** ВМ не запускается при загрузке хоста. <br> **Решение:** Убедиться, что демон `libvirtd` настроен на автозапуск (`systemctl enable libvirtd`). Проверить, что пулы хранилищ и сети, используемые ВМ, тоже имеют автозапуск. | Создает символическую ссылку в директории `/etc/libvirt/qemu/autostart/`. | Полезно для серверных ВМ, которые должны быть всегда доступны. |
| **Бэкап конфигурации** | Резервное копирование XML-конфигураций ВМ, сетей и пулов. | `virsh dumpxml`, `virsh net-dumpxml`, `virsh pool-dumpxml` | ```bash<br># Простой скрипт для бэкапа всех ВМ<br>for vm in $(virsh list --name --all); do<br>  virsh dumpxml "$vm" > "/backup/path/${vm}.xml"<br>done<br>``` | **Ошибка:** После восстановления ВМ не видит диск. <br> **Решение:** В бэкапе XML-конфига пути к дискам абсолютные. При переносе на другой хост нужно проверить и исправить эти пути. | Позволяет быстро восстановить конфигурацию в случае сбоя или для клонирования на другом хосте. | Бэкап не включает в себя сами дисковые образы (тома). Для их копирования используйте `rsync`, `dd` или `qemu-img`. |
| **Скриптование (Bash/Python)** | Использование CLI-команд в скриптах для автоматизации. | Вызов `virsh` из скрипта. Использование `libvirt-python` API для сложных задач. | ```bash<br>#!/bin/bash<br># Скрипт для запуска всех ВМ, у которых отключен автозапуск<br>for vm in $(virsh list --name --inactive); do<br>  if [[ $(virsh dominfo "$vm" \| grep "Autostart" \| awk '{print $2}') == "disable" ]]; then<br>    virsh start "$vm"<br>    echo "Started $vm"<br>  fi<br>done<br>``` | **Ошибка:** Скрипт не работает при запуске из cron. <br> **Решение:** В cron-задании необходимо установить переменные окружения, в частности `LIBVIRT_DEFAULT_URI`, или использовать полный путь к `virsh`. | Позволяет создавать сложные системы оркестрации, мониторинга и управления. | API на Python предоставляет более гибкий и производительный интерфейс по сравнению с парсингом вывода `virsh`. |

## Приложение: Полный справочник команд и конфигураций

Этот раздел служит исчерпывающим справочником по наиболее часто используемым командам `virsh` и ключевым элементам XML-конфигурации. Каждая команда и XML-секция предваряется комментарием, поясняющим её назначение и использование. Используйте этот раздел для быстрого поиска синтаксиса и параметров.

### Справочник команд Virsh

```bash
# Управление жизненным циклом доменов (ВМ)
virsh list [--all | --inactive]          # Список ВМ
virsh start <domain-name-or-uuid>        # Запуск ВМ
virsh shutdown <domain> [--mode acpi]    # Корректное выключение
virsh destroy <domain>                   # Аварийное выключение
virsh reboot <domain>                    # Перезагрузка
virsh suspend <domain>                   # Приостановка
virsh resume <domain>                    # Возобновление
virsh undefine <domain> [--remove-all-storage] [--snapshots-metadata] # Удаление конфигурации ВМ

# Просмотр и редактирование конфигурации
virsh dumpxml <domain>                   # Экспорт конфигурации в XML
virsh edit <domain>                      # Редактирование XML-конфигурации
virsh dominfo <domain>                   # Общая информация о ВМ
virsh autostart <domain> [--disable]     # Включить/выключить автозапуск

# Управление виртуальными сетями
virsh net-list [--all]                   # Список сетей
virsh net-info <network>                 # Информация о сети
virsh net-dumpxml <network>              # Экспорт конфигурации сети
virsh net-edit <network>                 # Редактирование сети
virsh net-start <network>                # Запуск сети
virsh net-destroy <network>              # Остановка сети
virsh net-autostart <network>            # Включить автозапуск сети

# Управление пулами хранилищ и томами
virsh pool-list [--all] [--details]      # Список пулов
virsh pool-info <pool>                   # Информация о пуле
virsh pool-dumpxml <pool>                # Экспорт конфигурации пула
virsh vol-list <pool>                    # Список томов в пуле
virsh vol-info <vol-name> --pool <pool>  # Информация о томе
virsh vol-create-as <pool> <name> <capacity> [--format qcow2/raw] # Создание тома
virsh vol-delete <vol-name> --pool <pool> # Удаление тома

# Мониторинг и диагностика
virsh domstats <domain> [--all]          # Статистика по ВМ
virsh vcpuinfo <domain>                  # Информация о vCPU
virsh domblklist <domain>                # Список дисков ВМ
virsh domiflist <domain>                 # Список сетевых интерфейсов ВМ
virsh console <domain>                   # Подключение к консоли

# Управление снимками (snapshots)
virsh snapshot-create-as <domain> <name> [--disk-only] [--atomic] # Создание снимка
virsh snapshot-list <domain>             # Список снимков ВМ
virsh snapshot-info <domain> <snapshot-name> # Информация о снимке
virsh snapshot-revert <domain> <snapshot-name> # Откат к снимку
virsh snapshot-delete <domain> <snapshot-name> [--metadata] # Удаление снимка
```

### Ключевые секции XML-конфигурации домена

```xml
<!-- Имя, UUID и описание домена -->
<name>ubuntu-vm</name>
<uuid>12345678-1234-1234-1234-123456789abc</uuid>
<description>Мой тестовый сервер Ubuntu</description>

<!-- Выделение памяти (в KiB) и настройки -->
<memory unit='KiB'>2097152</memory>  <!-- 2 GiB -->
<currentMemory unit='KiB'>2097152</currentMemory> <!-- Текущая память -->
<memoryBacking>
    <hugepages/> <!-- Опционально: использовать huge pages для производительности -->
</memoryBacking>

<!-- Выделение виртуальных процессоров -->
<vcpu placement='static'>2</vcpu> <!-- 2 vCPU -->

<!-- Операционная система: тип и загрузчик -->
<os>
    <type arch='x86_64' machine='pc-q35-6.2'>hvm</type> <!-- Тип: HVM -->
    <boot dev='hd'/> <!-- Устройство загрузки: диск -->
    <boot dev='cdrom'/> <!-- Устройство загрузки: CD-ROM -->
</os>

<!-- Устройства, подключенные к ВМ -->
<devices>
    <!-- Эмулятор (обычно QEMU) -->
    <emulator>/usr/bin/qemu-system-x86_64</emulator>

    <!-- Виртуальный диск -->
    <disk type='file' device='disk'>
        <driver name='qemu' type='qcow2' cache='none' io='native'/>
        <source file='/var/lib/libvirt/images/ubuntu-vm.qcow2'/>
        <target dev='vda' bus='virtio'/> <!-- Рекомендуется использовать virtio для производительности -->
        <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
    </disk>

    <!-- Виртуальный CD-ROM (для установки ОС) -->
    <disk type='file' device='cdrom'>
        <driver name='qemu' type='raw'/>
        <source file='/path/to/ubuntu-22.04.iso'/>
        <target dev='sda' bus='sata'/>
        <readonly/>
    </disk>

    <!-- Сетевой интерфейс (подключение к виртуальной сети 'default') -->
    <interface type='network'>
        <mac address='52:54:00:aa:bb:cc'/>
        <source network='default'/>
        <model type='virtio'/> <!-- Рекомендуется использовать virtio для производительности -->
    </interface>

    <!-- Графический вывод (VNC-сервер) -->
    <graphics type='vnc' port='-1' autoport='yes' listen='0.0.0.0'>
        <listen type='address' address='0.0.0.0'/>
    </graphics>

    <!-- Канал для гостевого агента QEMU -->
    <channel type='unix'>
        <target type='virtio' name='org.qemu.guest_agent.0'/>
    </channel>
</devices>
```
