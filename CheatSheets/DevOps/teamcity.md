# Руководство по созданию CI/CD пайплайна в TeamCity

## Содержание
1. [Терминология TeamCity](#терминология-teamcity)
2. [Установка и настройка TeamCity](#установка-и-настройка-teamcity)
3. [Создание конфигурации сборки](#создание-конфигурации-сборки)
4. [Настройка триггеров и зависимостей](#настройка-триггеров-и-зависимостей)
5. [Управление агентами сборки](#управление-агентами-сборки)
6. [Интеграции и автоматизация](#интеграции-и-автоматизация)
7. [Мониторинг и устранение неполадок](#мониторинг-и-устранение-неполадок)
8. [Справочник параметров конфигурации](#справочник-параметров-конфигурации)

## Терминология TeamCity

| Термин | Описание |
| --- | --- |
| Непрерывная интеграция (CI) | Практика частого объединения изменений кода в общий репозиторий с автоматическим выполнением тестов для выявления ошибок. Позволяет командам быстрее находить и устранять конфликты, обеспечивая стабильность кода. |
| Непрерывная доставка (CD) | Расширение CI, автоматизирующее развертывание кода в тестовые или продуктовые среды после успешной сборки. Ускоряет выпуск обновлений, минимизируя ручные операции. |
| Сборка (Build) | Процесс компиляции исходного кода, выполнения тестов и создания готовых к использованию файлов (артефактов). Сборка подтверждает работоспособность кода. |
| Пайплайн сборки | Последовательность этапов (сборка, тестирование, развертывание), определяющая процесс CI/CD. Обеспечивает структурированный подход к автоматизации. |
| Цепочка сборки | Набор связанных конфигураций сборки, выполняющихся последовательно или параллельно для достижения общей цели, например, сборки и развертывания приложения. |
| Артефакт сборки | Файлы, созданные в процессе сборки (например, .jar, .exe, .zip), которые сохраняются для дальнейшего использования или развертывания. |
| Триггер сборки | Условие или событие (например, коммит в репозиторий или расписание), инициирующее запуск сборки. Автоматизирует процесс CI/CD. |
| Агент сборки | Программный компонент, выполняющий задачи сборки на физической или виртуальной машине. Распределяет нагрузку от сервера TeamCity. |
| Репозиторий артефактов | Хранилище для управления артефактами сборки, обеспечивающее доступ к версиям и их повторное использование. |
| Пул агентов | Группа агентов сборки, объединенных для выполнения определенных задач. Упрощает управление ресурсами. |
| Снапшот-зависимость | Механизм, связывающий конфигурации сборки, чтобы использовать одну и ту же версию исходного кода для согласованности. |
| Плагин | Расширение функциональности TeamCity, добавляющее новые возможности, например, интеграцию с внешними инструментами. |
| Чистая сборка (Clean Build) | Сборка, выполняемая с удалением всех промежуточных файлов для устранения влияния предыдущих сборок. |
| Билд-тег (Build Tag) | Метка, присваиваемая сборке для упрощения поиска и категоризации, например, "release" или "stable". |

---

## Установка и настройка TeamCity

Установка TeamCity является первым шагом для создания CI/CD пайплайна, обеспечивая основу для автоматизации процессов сборки и развертывания. Этот раздел охватывает процесс установки сервера и агентов, настройки базовых параметров и подготовки системы к работе. Таблица ниже предоставляет структурированный обзор ключевых операций, их параметров и примеров, чтобы начинающие специалисты могли быстро освоить начальную конфигурацию. Понимание этих шагов критически важно, так как правильная установка влияет на стабильность и производительность всей системы. Ошибки на этом этапе могут привести к проблемам с доступом, производительностью или совместимостью, поэтому особое внимание уделяется типичным проблемам и их решениям. Таблица также включает рекомендации по оптимизации для различных платформ, чтобы обеспечить гибкость в разных окружениях.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Установка сервера TeamCity | Установка центрального компонента для управления сборками | `-platform`: Windows, Linux, macOS<br>`-port`: порт веб-интерфейса<br>`-data-dir`: директория данных | ```bash<br># Установка на Linux<br>sudo ./TeamCity-<version>.tar.gz -port=8111 -data-dir=/opt/teamcity-data<br>```<br>```bash<br># Установка на Windows<br>TeamCity-<version>.exe /port=8111<br>``` | **Ошибка**: Порт занят<br>**Решение**: Изменить порт в конфигурации или освободить порт<br>**Ошибка**: Недостаточно памяти<br>**Решение**: Увеличить JVM параметры в `teamcity-server.bat/sh` | Создает веб-интерфейс и базу данных | Требует подключения к СУБД (H2, PostgreSQL) |
| Настройка агента сборки | Подключение агента для выполнения задач сборки | `-agent-name`: имя агента<br>`-server-url`: URL сервера<br>`-auth-token`: токен авторизации | ```bash<br># Linux агент<br>./buildAgent/bin/agent.sh start -server-url=http://localhost:8111<br>```<br>```bash<br># Windows агент<br>buildAgent\bin\agent.bat start -agent-name=Agent1<br>``` | **Ошибка**: Агент не подключается<br>**Решение**: Проверить URL сервера и токен<br>**Ошибка**: Нехватка ресурсов<br>**Решение**: Уменьшить нагрузку на агента | Распределяет задачи сборки | Связан с пулом агентов и сервером |
| Инициализация базы данных | Настройка хранилища данных TeamCity | `-db-type`: тип СУБД (H2, MySQL, PostgreSQL)<br>`-db-host`: хост базы<br>`-db-name`: имя базы | ```bash<br># PostgreSQL<br>teamcity-server.sh -db-type=postgresql -db-host=localhost -db-name=teamcity<br>```<br>```bash<br># H2 (встроенная)<br>teamcity-server.sh -db-type=h2<br>``` | **Ошибка**: Ошибка соединения с БД<br>**Решение**: Проверить параметры подключения<br>**Ошибка**: Медленная БД<br>**Решение**: Использовать внешнюю СУБД вместо H2 | Определяет производительность системы | Влияет на сервер и веб-интерфейс |
| **Важно запомнить** | Для production рекомендуется PostgreSQL или MySQL вместо H2. Убедитесь, что порт сервера открыт в фаерволе. | | | | | |

---

## Создание конфигурации сборки

Конфигурация сборки является сердцем CI/CD пайплайна в TeamCity, определяя, как исходный код превращается в готовые артефакты. Этот раздел помогает новичкам создать и настроить конфигурацию сборки, включая шаги сборки, параметры и интеграцию с системами контроля версий. Таблица ниже предоставляет четкие инструкции по основным операциям, их параметрам и примерам, минимизируя необходимость в дополнительных пояснениях. Понимание этих операций позволяет автоматизировать процесс сборки, обеспечивая воспроизводимость и надежность. Таблица также учитывает типичные ошибки, такие как неправильная настройка шагов, и предлагает решения, чтобы начинающие могли быстро устранять проблемы. Особое внимание уделяется взаимодействию с другими компонентами, такими как агенты и триггеры, чтобы обеспечить целостность пайплайна.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Создание конфигурации сборки | Определение процесса сборки | `-vcs`: тип VCS (Git, SVN)<br>`-steps`: шаги сборки<br>`-artifacts`: путь к артефактам | ```yaml<br># Конфигурация для Git<br>vcs: git<br>url: https://github.com/user/repo.git<br>steps:<br>  - script: mvn clean install<br>artifacts: target/*.jar<br>```<br>```yaml<br># Простая сборка<br>steps:<br>  - script: npm install && npm build<br>artifacts: dist/*<br>``` | **Ошибка**: VCS недоступен<br>**Решение**: Проверить URL и учетные данные<br>**Ошибка**: Артефакты не найдены<br>**Решение**: Указать правильный путь | Определяет процесс CI | Связана с VCS и агентами |
| Добавление шага сборки | Задание этапа выполнения | `-type`: тип шага (script, maven, gradle)<br>`-script`: команда<br>`-work-dir`: рабочая директория | ```yaml<br># Maven шаг<br>type: maven<br>script: clean install<br>work-dir: ./app<br>```<br>```yaml<br># Скрипт<br>type: script<br>script: python tests.py<br>``` | **Ошибка**: Шаг не выполнен<br>**Решение**: Проверить синтаксис команды<br>**Ошибка**: Неправильная ОС<br>**Решение**: Указать совместимый агент | Влияет на результат сборки | Зависит от агента и окружения |
| **Типичные ошибки** | Неправильный путь к артефактам или некорректная команда шага. Всегда проверяйте совместимость агента с ОС. | | | | | |

---

## Настройка триггеров и зависимостей

Триггеры и зависимости позволяют автоматизировать запуск сборок и связывать их в цепочки, формируя полноценный CI/CD пайплайн. Этот раздел объясняет, как настроить триггеры для автоматического запуска сборок и зависимости для управления последовательностью выполнения. Таблица предоставляет компактное руководство по операциям, включая параметры, примеры и решения ошибок, чтобы новички могли настроить автоматизацию без лишних сложностей. Понимание этих элементов помогает создать гибкий и надежный пайплайн, реагирующий на изменения кода или расписание. Таблица также охватывает продвинутые сценарии, такие как снапшот-зависимости, и учитывает особенности разных платформ.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Настройка VCS триггера | Автоматический запуск при изменении кода | `-branch`: ветка<br>`-watch`: путь для мониторинга | ```yaml<br># Триггер на master<br>trigger: vcs<br>branch: master<br>watch: src/*<br>```<br>```yaml<br># Триггер на любой коммит<br>trigger: vcs<br>branch: *<br>``` | **Ошибка**: Триггер не срабатывает<br>**Решение**: Проверить ветку и права доступа<br>**Ошибка**: Частые сборки<br>**Решение**: Настроить фильтры | Автоматизирует CI | Связан с VCS и очередью сборки |
| Настройка снапшот-зависимости | Связывание сборок для согласованности | `-source-build`: исходная сборка<br>`-reuse-artifacts`: использовать артефакты | ```yaml<br># Зависимость от другой сборки<br>dependency: snapshot<br>source-build: Build1<br>reuse-artifacts: true<br>```<br>```yaml<br># Без артефактов<br>dependency: snapshot<br>source-build: Build2<br>``` | **Ошибка**: Зависимость не найдена<br>**Решение**: Проверить ID сборки<br>**Ошибка**: Артефакты устарели<br>**Решение**: Очистить кэш | Гарантирует согласованность | Влияет на цепочку сборки |
| **Важно запомнить** | Используйте снапшот-зависимости для крупных проектов с несколькими конфигурациями. | | | | | |

---

## Управление агентами сборки

Агенты сборки выполняют задачи, распределяя нагрузку от сервера TeamCity. Этот раздел помогает новичкам настроить и управлять агентами, обеспечивая их оптимальную работу. Таблица ниже охватывает ключевые операции, параметры и примеры, упрощая процесс для начинающих. Понимание управления агентами важно для масштабирования пайплайна и предотвращения узких мест. Таблица также включает рекомендации по устранению ошибок, таких как нехватка ресурсов, и учитывает особенности работы на разных ОС.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Добавление агента | Подключение нового агента | `-agent-name`: имя<br>`-pool`: пул агентов | ```bash<br># Linux агент<br>./buildAgent/bin/agent.sh start -agent-name=Agent2 -pool=Default<br>```<br>```bash<br># Windows агент<br>buildAgent\bin\agent.bat start -agent-name=Agent3<br>``` | **Ошибка**: Агент не авторизован<br>**Решение**: Проверить токен<br>**Ошибка**: Нехватка CPU<br>**Решение**: Уменьшить задачи | Увеличивает производительность | Связан с пулом и сервером |
| Настройка пула агентов | Группировка агентов | `-pool-name`: имя пула<br>`-requirements`: требования | ```yaml<br># Пул для Linux<br>pool-name: LinuxPool<br>requirements: os=linux<br>```<br>```yaml<br># Пул для Windows<br>pool-name: WinPool<br>requirements: os=windows<br>``` | **Ошибка**: Агент не соответствует требованиям<br>**Решение**: Проверить параметры агента<br>**Ошибка**: Пул переполнен<br>**Решение**: Добавить агенты | Оптимизирует распределение | Влияет на очередь сборки |
| **Типичные ошибки** | Неправильная настройка требований пула может привести к простою агентов. | | | | | |

---

## Интеграции и автоматизация

Интеграции и автоматизация расширяют возможности TeamCity, позволяя подключать внешние инструменты и оптимизировать процессы. Этот раздел охватывает настройку плагинов, интеграцию с Docker и автоматизацию через скрипты. Таблица предоставляет компактные инструкции для новичков, включая примеры и решения ошибок. Понимание этих операций помогает создать масштабируемый и гибкий пайплайн, особенно для сложных проектов. Таблица также учитывает продвинутые сценарии, такие как использование Docker для изоляции сборок.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Установка плагина | Расширение функциональности | `-plugin`: имя плагина<br>`-version`: версия | ```bash<br># Установка плагина Slack<br>teamcity-plugin-install slack -version=1.0<br>```<br>```bash<br># Установка плагина Docker<br>teamcity-plugin-install docker-support<br>``` | **Ошибка**: Плагин несовместим<br>**Решение**: Проверить версию TeamCity<br>**Ошибка**: Плагин не загружается<br>**Решение**: Перезапустить сервер | Добавляет новые возможности | Влияет на сервер и сборки |
| Интеграция с Docker | Использование контейнеров для сборки | `-image`: образ Docker<br>`-run`: команда | ```yaml<br># Сборка в контейнере<br>type: docker<br>image: maven:3.8<br>run: mvn clean install<br>```<br>```yaml<br># Тесты в контейнере<br>type: docker<br>image: node:16<br>run: npm test<br>``` | **Ошибка**: Образ не найден<br>**Решение**: Проверить реестр Docker<br>**Ошибка**: Ограничения ресурсов<br>**Решение**: Настроить лимиты | Изолирует окружение | Требует Docker на агенте |
| **Важно запомнить** | Используйте Docker для воспроизводимости окружений, но проверяйте наличие Docker на агентах. | | | | | |

---

## Мониторинг и устранение неполадок

Мониторинг и устранение неполадок обеспечивают стабильность CI/CD пайплайна. Этот раздел помогает новичкам отслеживать сборки и устранять проблемы, такие как сбои или медленные сборки. Таблица предоставляет инструкции по основным операциям, включая просмотр логов и управление очередью. Понимание этих операций позволяет быстро реагировать на сбои и оптимизировать производительность. Таблица также охватывает типичные ошибки и их решения, упрощая процесс для начинающих.

| Команда/Операция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
| --- | --- | --- | --- | --- | --- | --- |
| Просмотр логов сборки | Анализ результатов сборки | `-build-id`: ID сборки<br>`-level`: уровень логов | ```bash<br># Полный лог<br>teamcity-log -build-id=123 -level=debug<br>```<br>```bash<br># Краткий лог<br>teamcity-log -build-id=123 -level=info<br>``` | **Ошибка**: Лог недоступен<br>**Решение**: Проверить права доступа<br>**Ошибка**: Лог слишком большой<br>**Решение**: Фильтровать по уровню | Помогает диагностике | Связан с сервером и артефактами |
| Управление очередью сборки | Приоритизация задач | `-build-id`: ID сборки<br>`-priority`: приоритет | ```bash<br># Повысить приоритет<br>teamcity-queue -build-id=123 -priority=high<br>```<br>```bash<br># Отменить сборку<br>teamcity-queue -build-id=123 -action=cancel<br>``` | **Ошибка**: Очередь переполнена<br>**Решение**: Добавить агенты<br>**Ошибка**: Сборка не отменяется<br>**Решение**: Перезапустить очередь | Оптимизирует выполнение | Влияет на агенты и триггеры |
| **Типичные ошибки** | Неправильная фильтрация логов может затруднить диагностику. Используйте уровень debug для детального анализа. | | | | | |

---

## Справочник параметров конфигурации

```yaml
# Конфигурация VCS
vcs:
  type: git                        # Тип системы контроля версий (git, svn)
  url: https://github.com/user/repo.git  # URL репозитория
  branch: master                   # Ветка для мониторинга
  credentials: user:pass           # Учетные данные (опционально)

# Шаги сборки
steps:
  - type: script                   # Тип шага (script, maven, gradle, docker)
    script: mvn clean install      # Команда для выполнения
    work-dir: ./app                # Рабочая директория
  - type: docker
    image: node:16                 # Docker образ
    run: npm test                  # Команда в контейнере

# Артефакты
artifacts:
  path: target/*.jar              # Путь к артефактам
  publish: true                   # Публиковать в репозиторий артефактов

# Триггеры
triggers:
  - type: vcs                      # Тип триггера (vcs, schedule)
    branch: master                 # Ветка для триггера
    watch: src/*                   # Мониторинг изменений
  - type: schedule
    cron: 0 0 * * *               # Расписание (ежедневно в полночь)

# Зависимости
dependencies:
  - type: snapshot                # Тип зависимости (snapshot, artifact)
    source-build: Build1           # ID исходной сборки
    reuse-artifacts: true          # Использовать артефакты

# Параметры агента
agent-requirements:
  os: linux                      # Требуемая ОС
  java-version: 11               # Версия Java
```