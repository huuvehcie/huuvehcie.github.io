# Podman Compose

## Содержание
- [Термины и определения](#термины-и-определения)
- [Введение в Podman Compose](#введение-в-podman-compose)
- [Основные команды Podman Compose](#основные-команды-podman-compose)
- [Конфигурация podman-compose.yml](#конфигурация-podman-composeyml)
- [Сети и тома](#сети-и-тома)
- [Продвинутые сценарии](#продвинутые-сценарии)
- [Пример podman-compose файла](#пример-podman-compose-файла)

## Термины и определения

| Термин | Определение |
|--------|-------------|
| **Podman** | Инструмент для управления контейнерами, аналог Docker, работающий без демона, поддерживающий rootless-режим (без прав суперпользователя). Используется для запуска, управления и удаления контейнеров. |
| **Podman Compose** | Утилита для управления многоконтейнерными приложениями с помощью YAML-файлов, аналог Docker Compose. Позволяет определять и запускать сервисы, сети и тома. |
| **Контейнер** | Изолированная среда для выполнения приложений, содержащая код, зависимости и конфигурации. Легче и быстрее виртуальных машин. |
| **Образ** | Статический шаблон, содержащий приложение, библиотеки и зависимости, на основе которого создаются контейнеры. Хранится в реестрах, таких как Docker Hub или quay.io. |
| **Сервис** | Определение контейнера в podman-compose.yml, включающее образ, порты, тома и другие настройки. Каждый сервис — отдельный контейнер. |
| **Том (Volume)** | Механизм для хранения данных контейнеров вне их файловой системы. Обеспечивает персистентность данных при перезапуске или удалении контейнеров. |
| **Сеть (Network)** | Виртуальная сеть для связи между контейнерами. В Podman поддерживаются bridge-сети (по умолчанию) и другие типы для изоляции или взаимодействия. |
| **Rootless** | Режим работы Podman без root-прав, обеспечивающий безопасность, но с ограничениями (например, некоторые порты или функции могут быть недоступны). |
| **Pod** | Группа контейнеров, работающих вместе и разделяющих ресурсы (например, сеть). Аналог Kubernetes Pod, используется в Podman для упрощения управления. |
| **Жаргон: "Спин-ап"** | Запуск контейнеров или сервисов с помощью команды, например, `podman-compose up`. |
| **Жаргон: "Билдить"** | Создание образа контейнера из Dockerfile или исходного кода. |

## Введение в Podman Compose

Podman Compose — это инструмент, который упрощает управление многоконтейнерными приложениями, позволяя описывать сервисы, сети и тома в одном YAML-файле. Он предназначен для начинающих и опытных пользователей, работающих в средах, где требуется высокая безопасность и отсутствие демона, как в Docker. Это руководство поможет освоить базовые и продвинутые аспекты Podman Compose, включая настройку, запуск и устранение проблем. Таблицы ниже предоставляют структурированную информацию о командах, параметрах и сценариях, чтобы быстро начать работу и избежать типичных ошибок. Каждая таблица сопровождается примерами, пояснениями ошибок и рекомендациями по оптимизации, что делает её основным источником знаний для новичков.

Таблицы ориентированы на практическое применение, охватывая весь цикл работы с Podman Compose: от установки и запуска сервисов до настройки сетей, томов и автоматизации. Они включают примеры для разных операционных систем, что важно для понимания совместимости и ограничений. Пояснения к таблицам раскрывают контекст использования, помогая понять, где и как применять команды или настройки, а также их влияние на систему. Руководство минимизирует текст вне таблиц, сосредотачиваясь на компактной, но полной информации, чтобы начинающие могли быстро освоить инструмент и перейти к реальным задачам.

## Основные команды Podman Compose

Podman Compose предоставляет набор команд для управления многоконтейнерными приложениями, которые запускаются из YAML-файла. Эти команды позволяют запускать, останавливать, перезапускать и мониторить сервисы, а также управлять их жизненным циклом. Таблица ниже охватывает ключевые команды, их параметры, примеры использования, типичные ошибки и влияние на систему. Она предназначена для быстрого старта, помогая новичкам понять, как управлять сервисами и решать проблемы, такие как конфликты портов или отсутствие прав.

Таблица также учитывает различия между rootless и rootful режимами, что критично для пользователей Linux, где Podman часто используется без привилегий. Примеры включают комментарии для ясности, а разделы об ошибках и взаимодействии помогают избежать сбоев при интеграции с другими инструментами. Эта информация формирует базис для дальнейшего изучения Podman Compose, позволяя переходить к более сложным сценариям, описанным в следующих разделах.

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `podman-compose up` | Запускает все сервисы из podman-compose.yml. | `-d` — фоновый режим<br>`--build` — пересобирает образы | ```bash<br># Запуск в фоновом режиме<br>podman-compose up -d<br>```<br>```bash<br># Пересборка и запуск<br>podman-compose up --build<br>``` | **Ошибка:** Порт занят<br>**Решение:** Проверить `ss -tuln`, изменить порт в YAML<br>**Ошибка:** Нет прав<br>**Решение:** Запустить с `sudo` или настроить rootless | Создает контейнеры, сети, тома. Может нагружать CPU/память. | Сети/тома создаются автоматически. Конфликты с другими контейнерами. |
| `podman-compose down` | Останавливает и удаляет сервисы, сети, но сохраняет тома. | `-v` — удаляет тома<br>`--remove-orphans` — удаляет неопределённые сервисы | ```bash<br># Остановка и удаление<br>podman-compose down<br>```<br>```bash<br># Удаление с томами<br>podman-compose down -v<br>``` | **Ошибка:** Сеть не удаляется<br>**Решение:** Удалить вручную: `podman network rm <name>` | Освобождает ресурсы, но данные в томах сохраняются. | Удаляет только связанные сети. Тома требуют `-v`. |
| `podman-compose ps` | Показывает статус запущенных сервисов. | `-a` — включает остановленные | ```bash<br># Статус текущих<br>podman-compose ps<br>```<br>```bash<br># Все сервисы<br>podman-compose ps -a<br>``` | **Ошибка:** Нет сервисов<br>**Решение:** Убедиться, что `up` выполнен | Минимальная нагрузка. Только чтение. | Зависит от состояния контейнеров. |
| `podman-compose logs` | Отображает логи сервисов. | `--tail=n` — последние n строк<br>`-f` — следить в реальном времени | ```bash<br># Логи всех сервисов<br>podman-compose logs<br>```<br>```bash<br># Последние 10 строк<br>podman-compose logs --tail=10<br>``` | **Ошибка:** Логи пусты<br>**Решение:** Проверить, запущены ли сервисы | Минимальная нагрузка. | Логи могут быть большими, влияет на диск. |

**Важно запомнить:** Команды работают только в директории с `podman-compose.yml`. Rootless-режим может ограничивать порты < 1024.  
**Типичные ошибки:** Неправильный путь к файлу YAML (проверить `pwd`), отсутствие установленного `podman-compose` (установить через пакетный менеджер).

## Конфигурация podman-compose.yml

Файл `podman-compose.yml` — основа для определения многоконтейнерных приложений. Он описывает сервисы, их образы, порты, тома, сети и другие параметры. Таблица ниже детализирует ключевые секции файла, их назначение, параметры и примеры, а также ошибки, которые могут возникнуть при неправильной конфигурации. Она помогает новичкам правильно настроить сервисы, избегая типичных проблем, таких как неверные пути к томам или конфликты сетей.

Таблица охватывает базовые и продвинутые настройки, включая ограничение ресурсов и зависимости, что важно для оптимизации и безопасности. Пояснения к ошибкам и взаимодействию помогают понять, как конфигурация влияет на контейнеры и систему в целом. Примеры включают комментарии для ясности, а информация о совместимости учитывает особенности rootless-режима и разных ОС.

| Секция | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|--------|------------|-----------|---------|------------------|---------|----------------|
| `services` | Определяет контейнеры (сервисы). | `image`, `build`, `command`, `ports`, `volumes`, `environment`, `depends_on`, `networks`, `resources` | ```yaml<br>web:<br>  image: python:3.9<br>  command: python app.py<br>  ports:<br>    - "8000:8000"<br>  volumes:<br>    - ./src:/app<br>``` | **Ошибка:** Образ не найден<br>**Решение:** Проверить реестр, выполнить `podman pull`<br>**Ошибка:** Порт занят<br>**Решение:** Изменить порт в `ports` | Создает контейнеры с заданными настройками. | Влияет на сети, тома, ресурсы. |
| `image` | Указывает базовый образ для сервиса. | Имя образа:тег | ```yaml<br>image: postgres:13<br>```<br>```yaml<br>image: quay.io/myapp:latest<br>``` | **Ошибка:** Образ недоступен<br>**Решение:** Проверить сеть или реестр | Загружает образ, увеличивает использование диска. | Требует сети для загрузки. |
| `build` | Сборка образа из Dockerfile. | `context`, `dockerfile` | ```yaml<br>build:<br>  context: ./web<br>  dockerfile: Dockerfile<br>``` | **Ошибка:** Dockerfile не найден<br>**Решение:** Проверить путь в `context` | Создает новый образ, нагружает CPU. | Требует локальных файлов. |
| `ports` | Связывает порты хоста и контейнера. | Формат: `host:container` | ```yaml<br>ports:<br>  - "8000:8000"<br>``` | **Ошибка:** Порт < 1024 в rootless<br>**Решение:** Использовать порты > 1024 | Открывает доступ к сервису. | Конфликты с другими сервисами. |
| `volumes` | Монтирует директории или файлы. | Формат: `host:container` или именованный том | ```yaml<br>volumes:<br>  - ./src:/app<br>  - data_volume:/data<br>``` | **Ошибка:** Путь не существует<br>**Решение:** Создать директорию на хосте | Данные сохраняются вне контейнера. | Требует прав доступа. |
| `environment` | Задает переменные окружения. | Ключ:значение или `env_file` | ```yaml<br>environment:<br>  APP_ENV: production<br>``` | **Ошибка:** Переменная не передана<br>**Решение:** Проверить синтаксис | Влияет на поведение приложения. | Зависит от приложения. |

**Важно запомнить:** Проверяйте синтаксис YAML (отступы — 2 пробела). Rootless-режим требует прав на тома.  
**Типичные ошибки:** Неправильные пути в `volumes` (проверить `ls`), дублирование портов (изменить в `ports`).

## Сети и тома

Сети и тома в Podman Compose обеспечивают связь между контейнерами и персистентность данных. Сети позволяют сервисам взаимодействовать, а тома сохраняют данные при перезапуске или удалении контейнеров. Таблица ниже описывает настройки сетей и томов, их параметры, примеры и ошибки, помогая новичкам правильно конфигурировать инфраструктуру приложения.

Таблица включает информацию о драйверах сетей (например, bridge) и типах томов (локальные или именованные), а также сценарии интеграции, такие как подключение к внешним сетям. Пояснения к ошибкам и взаимодействию помогают избежать проблем, таких как недоступность сети или потеря данных. Примеры демонстрируют настройку для типичных случаев, а информация о совместимости учитывает ограничения rootless-режима.

| Элемент | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| `networks` | Создает сети для связи сервисов. | `driver` (обычно `bridge`) | ```yaml<br>networks:<br>  app_network:<br>    driver: bridge<br>``` | **Ошибка:** Сеть не создана<br>**Решение:** Проверить `podman network ls` | Изолирует или соединяет сервисы. | Требует подключения сервисов. |
| `volumes` | Создает тома для хранения данных. | Имя тома | ```yaml<br>volumes:<br>  db_data:<br>``` | **Ошибка:** Том недоступен<br>**Решение:** Проверить права: `chmod`/`chown` | Данные сохраняются вне контейнеров. | Требует прав и монтирования. |

**Важно запомнить:** Сети по умолчанию — bridge. Тома требуют прав доступа в rootless-режиме.  
**Типичные ошибки:** Конфликты имен сетей (изменить имя), отсутствие прав на тома (настроить SELinux).

## Продвинутые сценарии

Продвинутые сценарии включают ограничение ресурсов, зависимости, автоматизацию и безопасность. Таблица ниже описывает настройки для этих задач, включая примеры интеграции с внешними инструментами и скриптами. Она предназначена для пользователей, которые освоили базовые команды и хотят оптимизировать или защитить свои приложения.

Таблица охватывает сложные случаи, такие как настройка ресурсов для предотвращения перегрузки системы или использование `depends_on` для управления порядком запуска. Примеры включают автоматизацию с помощью скриптов, а информация об ошибках помогает устранять проблемы, связанные с ограничениями rootless-режима или неверной конфигурацией.

| Сценарий | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|----------|------------|-----------|---------|------------------|---------|----------------|
| Ограничение ресурсов | Ограничивает CPU и память. | `resources.limits.cpus`, `resources.limits.memory` | ```yaml<br>resources:<br>  limits:<br>    cpus: '0.5'<br>    memory: 512M<br>``` | **Ошибка:** Лимиты игнорируются<br>**Решение:** Проверить поддержку cgroups | Снижает нагрузку на систему. | Требует cgroups v2. |
| Зависимости | Определяет порядок запуска. | `depends_on` | ```yaml<br>depends_on:<br>  - db<br>``` | **Ошибка:** Сервис не готов<br>**Решение:** Добавить `wait-for-it.sh` | Управляет порядком запуска. | Требует скриптов для проверки готовности. |
| Автоматизация | Запуск через скрипты. | Bash-скрипты | ```bash<br>#!/bin/bash<br>podman-compose up -d<br>podman-compose logs<br>``` | **Ошибка:** Скрипт не выполняется<br>**Решение:** Проверить права: `chmod +x` | Упрощает управление. | Требует правильных путей. |

**Важно запомнить:** Используйте `wait-for-it.sh` для проверки готовности сервисов. Настройте SELinux для rootless.  
**Типичные ошибки:** Ограничения ресурсов не работают без cgroups v2, скрипты не выполняются без прав.

## Пример podman-compose файла

Ниже приведён полный пример файла `podman-compose.yml` из исходного документа, включая все комментарии, без изменений.

```yaml
# Версия спецификации Podman Compose (version)
# Указывает версию формата файла podman-compose.yml.
# Podman Compose использует тот же формат, что и Docker Compose, но с учетом особенностей Podman.
version: '3.8'

# Определяем сервисы (services)
# services — это основной раздел, где описываются контейнеры.
# Каждый сервис представляет собой отдельный контейнер.
services:
  # Первый сервис: web-приложение
  web:
    # Используем базовый образ (image)
    # image указывает, какой образ будет использоваться для контейнера.
    # Можно использовать готовый образ из реестра (например, quay.io или Docker Hub).
    # Пример: image: python:3.9
    image: python:3.9

    # Альтернатива: сборка образа из Dockerfile (build)
    # build указывает путь к Dockerfile для создания образа.
    # context — корневая директория для сборки.
    # dockerfile — имя Dockerfile (по умолчанию "Dockerfile").
    # Пример 1: Сборка из текущей директории
    # build: .
    # Пример 2: Сборка с указанием контекста и Dockerfile
    # build:
    #   context: ./web
    #   dockerfile: Dockerfile.prod

    # Указываем команду для запуска контейнера (command)
    # command заменяет CMD в Dockerfile.
    # Пример 1: Запуск Python-скрипта
    command: python app.py
    # Пример 2: Передача нескольких аргументов
    # command: ["python", "app.py", "--debug"]

    # Публикуем порты (ports)
    # ports связывает порты хостовой системы с портами контейнера.
    # Формат: "хост:контейнер".
    # Пример 1: Открытие порта 8000
    ports:
      - "8000:8000"
    # Пример 2: Открытие нескольких портов
    # ports:
    #   - "8000:8000"
    #   - "8080:80"
    # Пример 3: Только внутренний порт (доступен только внутри сети Podman)
    # ports:
    #   - "8000"

    # Монтируем тома (volumes)
    # volumes позволяют монтировать директории или файлы между хостом и контейнером.
    # Пример 1: Монтирование директории с кодом
    volumes:
      - ./src:/app
    # Пример 2: Монтирование локального файла
    # volumes:
    #   - ./config.json:/app/config.json
    # Пример 3: Монтирование именованного тома
    # volumes:
    #   - data_volume:/data

    # Указываем переменные окружения (environment)
    # environment задает переменные окружения внутри контейнера.
    # Пример 1: Явное указание переменных
    environment:
      APP_ENV: production
      LOG_LEVEL: info
    # Пример 2: Загрузка переменных из файла
    # env_file:
    #   - .env

    # Указываем зависимости (depends_on)
    # depends_on определяет порядок запуска контейнеров.
    # Важно: Это только гарантирует порядок запуска, но не ждет готовности сервисов.
    # Для проверки готовности используйте скрипты или инструменты вроде wait-for-it.sh.
    depends_on:
      - db

    # Задаем метки для контейнера (labels)
    # labels добавляют метаданные к контейнеру.
    # Пример:
    labels:
      com.example.description: "Web application"
      com.example.version: "1.0"

    # Указываем сетевые настройки (networks)
    # networks задает сети, к которым подключается контейнер.
    # Пример:
    networks:
      - app_network

    # Ограничиваем ресурсы (resources)
    # resources позволяет настроить ресурсы для контейнера (например, CPU, память).
    # В отличие от Docker Compose, Podman Compose поддерживает ограничения ресурсов напрямую.
    resources:
      limits:
        cpus: '0.5'
        memory: 512M

  # Второй сервис: база данных
  db:
    # Используем базовый образ PostgreSQL
    image: postgres:13

    # Указываем переменные окружения для PostgreSQL
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb

    # Монтируем том для хранения данных базы данных
    volumes:
      - db_data:/var/lib/postgresql/data

    # Подключаемся к пользовательской сети
    networks:
      - app_network

# Определяем именованные тома (volumes)
# volumes создают именованные тома для хранения данных.
# Пример 1: Создание тома db_data
volumes:
  db_data:
  # Пример 2: Создание дополнительного тома
  data_volume:

# Определяем сети (networks)
# networks создают пользовательские сети для связи контейнеров.
# Пример: Создание сети app_network с драйвером bridge
networks:
  app_network:
    driver: bridge
```
