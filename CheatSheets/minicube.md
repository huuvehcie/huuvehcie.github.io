# Сжатое руководство по Minikube

Это структурированное руководство по Minikube для начинающих и специалистов среднего уровня, сжатое с использованием таблиц для сохранения детализации. Оно охватывает команды, настройки, сценарии использования и устранение ошибок для локального одноузлового кластера Kubernetes.

## 1. Введение в Minikube

Minikube — инструмент для запуска локального кластера Kubernetes в виртуальной машине или контейнере. Идеален для разработки и обучения.

| **Аспект** | **Описание** |
|------------------------|-----------------------------------------------------------------------------|
| **Назначение** | Тестирование приложений Kubernetes без облачного кластера |
| **Особенности** | Локальный кластер, поддержка драйверов (Docker, VirtualBox), дополнения |
| **Требования** | 2 CPU, 2 ГБ RAM, 20 ГБ диска, гипервизор/контейнер, `kubectl` |

---

## 2. Установка и настройка

| **Шаг** | **Команда/Действие** | **Примечания** |
|------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------|
| **Установка (Linux)** | `curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && sudo install minikube-linux-amd64 /usr/local/bin/minikube` | Добавить в PATH |
| **Установка (macOS)** | `brew install minikube` | Требуется Homebrew |
| **Установка (Windows)**| `choco install minikube` или скачать с GitHub | Требуется Chocolatey или ручная установка |
| **Драйверы** | Docker, VirtualBox, KVM2 (Linux), HyperKit (macOS), Hyper-V (Windows) | Docker — самый быстрый |
| **Проверка** | `minikube version` | Подтверждает успешную установку |
| **Ошибки** | `command not found` → Добавить в PATH<br>`Driver not found` → Установить драйвер | Пример: `sudo apt install docker.io` для Docker |

---

## 3. Управление кластером

| **Команда** | **Назначение** | **Флаги** | **Примеры** | **Влияние** | **Ошибки и решения** |
|------------------------|---------------------------------------------|------------------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube start` | Запускает кластер | `--driver`, `--cpus`, `--memory`, `--disk-size`, `--kubernetes-version` | 1. `minikube start`<br>2. `minikube start --driver=docker --cpus=4 --memory=4000`<br>3. `minikube start --kubernetes-version=v1.23.0` | Хост: использует ресурсы<br>Кластер: инициализирует API-сервер, kubelet, etcd<br>`kubectl`: настраивает контекст | `DRV_NOT_HEALTHY` → Запустить Docker<br>`Insufficient memory` → Уменьшить `--memory` |
| `minikube stop` | Останавливает кластер | `--profile` | 1. `minikube stop`<br>2. `minikube stop --profile=mycluster` | Хост: освобождает ресурсы<br>Кластер: приостанавливает компоненты | `No cluster found` → Проверить `minikube status` |
| `minikube delete` | Удаляет кластер | `--profile`, `--all` | 1. `minikube delete`<br>2. `minikube delete --all` | Хост: освобождает все ресурсы<br>Кластер: удаляет все данные | `Failed to delete` → Остановить кластер или использовать `--all` |
| `minikube status` | Показывает статус кластера | `--profile` | 1. `minikube status`<br>2. `minikube status --profile=mycluster` | Хост/Кластер: без влияния<br>Проверяет API-сервер, kubelet, хост | `Stopped/Not found` → Запустить кластер или проверить профиль |
| `minikube dashboard` | Открывает Kubernetes Dashboard | `--url`, `--port` | 1. `minikube dashboard`<br>2. `minikube dashboard --url` | Хост: открывает браузер/порт<br>Кластер: разворачивает под Dashboard | `Pod not found` → Включить `minikube addons enable dashboard`<br>`Port in use` → Изменить порт |

**Важно**: Используйте `stop` для экономии ресурсов, `delete` для очистки, `status` перед `kubectl`.

---

## 4. Настройка ресурсов

| **Флаг** | **Назначение** | **Пример** | **Влияние** |
|------------------------|--------------------------------------|-----------------------|-----------------------------------------------------------------------------|
| `--driver` | Драйвер виртуализации | `docker`, `virtualbox`| Хост: определяет технологию<br>Кластер: влияет на производительность |
| `--cpus` | Количество CPU | `4` | Хост: увеличивает нагрузку<br>Кластер: больше подов |
| `--memory` | Объем памяти (МБ) | `4000` | Хост: увеличивает нагрузку<br>Кластер: больше подов |
| `--disk-size` | Размер диска | `20g` | Хост: увеличивает использование диска<br>Кластер: больше хранилища |
| `--kubernetes-version` | Версия Kubernetes | `v1.23.0` | Кластер: определяет поведение API и компонентов |

### Драйверы
| **Драйвер** | **ОС** | **Плюсы** | **Минусы** |
|-------------|--------------------------|------------------------------------|-----------------------------------------|
| Docker | Linux, macOS, Windows | Быстрый, легковесный | Требуется Docker Desktop (macOS/Windows) |
| VirtualBox | Все | Кроссплатформенный, стабильный | Медленный, больше ресурсов |
| KVM2 | Linux | Высокая производительность | Только Linux, сложная настройка |
| HyperKit | macOS | Нативная интеграция | Только macOS |
| None | Linux | Без оверхеда VM | Требует root, изменяет хост |

**Пример**: `minikube start --driver=docker --cpus=4 --memory=6000 --disk-size=30g --kubernetes-version=v1.24.0`

**Ошибки**: `Resources exceed capacity` → Уменьшить ресурсы; `Driver not supported` → Установить драйвер.

**Важно**: Docker — лучший выбор; для разработки хватит 2 CPU и 4 ГБ RAM.

---

## 5. Сетевые функции и сервисы

| **Команда** | **Назначение** | **Флаги** | **Примеры** | **Влияние** | **Ошибки и решения** |
|------------------------|---------------------------------------------|---------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube service` | Доступ к сервису | `--url`, `--namespace` | 1. `minikube service my-service`<br>2. `minikube service my-service --url`<br>3. `minikube service my-service --namespace=my-ns` | Хост: выделяет порт<br>Кластер: проксирует сервис | `Service not found` → Проверить `kubectl get svc`<br>`Port not accessible` → Изменить порт |
| `minikube tunnel` | Доступ к LoadBalancer | None | `minikube tunnel` | Хост: требует sudo<br>Кластер: дает внешний IP | `Permission denied` → Использовать `sudo`<br>`Not connecting` → Проверить `minikube status` |
| `minikube mount` | Монтирует директорию хоста | `--uid`, `--gid` | 1. `minikube mount /home/user/data:/data`<br>2. `minikube mount /home/user/data:/data --uid=1000` | Хост: синхронизирует файлы<br>Кластер: файлы доступны подам | `Mount failed` → Проверить директорию<br>`Permission issues` → Указать `--uid`/`--gid` |

**Важно**: Используйте `mount` для разработки, `tunnel` для LoadBalancer, `--url` для программного доступа.

---

## 6. Дополнения и расширения

| **Команда** | **Назначение** | **Примеры** | **Влияние** | **Ошибки и решения** |
|---------------------------|---------------------------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube addons list` | Список дополнений | `minikube addons list` | Хост/Кластер: без влияния | None |
| `minikube addons enable` | Включение дополнения | `minikube addons enable ingress` | Кластер: разворачивает поды в `kube-system` | `Addon not found` → Проверить список<br>`Failed to enable` → Проверить логи |
| `minikube addons disable` | Отключение дополнения | `minikube addons disable dashboard` | Кластер: удаляет поды дополнения | Same as above |

**Популярные дополнения**: `dashboard`, `ingress`, `metrics-server`, `registry`.

**Важно**: Включайте только нужные дополнения, чтобы сэкономить ресурсы.

---

## 7. Отладка и устранение неисправностей

| **Команда** | **Назначение** | **Флаги** | **Примеры** | **Влияние** | **Ошибки и решения** |
|------------------------|---------------------------------------------|---------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube logs` | Вывод логов кластера | `--problems` | 1. `minikube logs`<br>2. `minikube logs --problems` | Хост/Кластер: без влияния | `No logs available` → Проверить `minikube status` |
| `minikube ssh` | SSH-доступ к узлу | None | 1. `minikube ssh`<br>2. `minikube ssh "docker ps"` | Хост/Кластер: позволяет изменять узел | `SSH connection failed` → Проверить `minikube status` |
| `minikube config` | Управление конфигурацией | `set`, `get`, `unset` | 1. `minikube config set driver docker`<br>2. `minikube config view` | Хост: изменяет `~/.minikube/config`<br>Кластер: влияет на следующий запуск | `Invalid property` → Проверить свойства |

**Важно**: Используйте `logs --problems` для быстрой диагностики, `ssh` для низкоуровневых проверок.

---

## 8. Работа с образами

| **Команда** | **Назначение** | **Флаги** | **Примеры** | **Влияние** | **Ошибки и решения** |
|------------------------|---------------------------------------------|---------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube cache` | Кэширование образов | `add`, `delete`, `reload` | 1. `minikube cache add my-image:latest`<br>2. `minikube cache reload` | Хост: использует диск<br>Кластер: ускоряет развертывание | `Image not found` → Проверить `docker images` |
| `minikube image` | Управление образами | `build`, `load`, `remove` | 1. `minikube image build -t my-image:latest .`<br>2. `minikube image load my-image:latest` | Хост: требует Docker<br>Кластер: делает образы доступными | `Failed to load` → Проверить образ |

**Важно**: Используйте `image build` для быстрой разработки, `cache` для оффлайн-сценариев.

---

## 9. Профили и управление несколькими кластерами

| **Команда** | **Назначение** | **Примеры** | **Влияние** | **Ошибки и решения** |
|------------------------|---------------------------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
| `minikube profile` | Переключение/управление профилями | 1. `minikube start --profile=cluster1`<br>2. `minikube profile cluster1`<br>3. `minikube profile list` | Хост: больше ресурсов<br>Кластер: изолированные окружения | `Profile not found` → Проверить `minikube profile list` |

**Важно**: Профили удобны для тестирования разных версий Kubernetes или настроек.

---

## 10. Продвинутые сценарии использования

### Тестирование Helm-чартов
| **Шаг** | **Команда/Действие** | **Примечания** |
|------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------|
| Установка Helm | `curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash` | Требуется интернет |
| Развертывание | `helm install my-release nginx-stable/nginx-ingress` | Добавить репо: `helm repo add nginx-stable https://helm.nginx.com/stable` |
| Тестирование | Включить `ingress`, создать Ingress-ресурс, проверить маршруты | Ошибка: `Chart not found` → Добавить репо |

### Настройка Ingress
| **Шаг** | **Команда/Действие** | **Примечания** |
|------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------|
| Включение | `minikube addons enable ingress` | Разворачивает NGINX Ingress |
| Ingress-ресурс | ```yaml<br>apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br> name: example-ingress<br>spec:<br> rules:<br> - host: example.local<br> http:<br> paths:<br> - path: /<br> pathType: Prefix<br> backend:<br> service:<br> name: my-service<br> port:<br> number: 80<br>``` | Применить: `kubectl apply -f ingress.yaml` |
| Хост | `echo "$(minikube ip) example.local" | sudo tee -a /etc/hosts` | Доступ: `curl http://example.local` |
| Ошибки | `503 Service Unavailable` → Проверить поды (`kubectl get pods`) | |

### Настройка TLS
| **Шаг** | **Команда/Действие** | **Примечания** |
|------------------------|-------------------------------------------------------------------------------------|----------------------------------------------------|
| Сертификат | `openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=example.local"` | Создает самоподписанный сертификат |
| Секрет | `kubectl create secret tls tls-secret --key tls.key --cert tls.crt` | Для Ingress |
| Обновление Ingress | ```yaml<br>spec:<br> tls:<br> - hosts:<br> - example.local<br> secretName: tls-secret<br>``` | Применить обновленный Ingress |
| Тестирование | `curl https://example.local` | Ошибка: `Certificate invalid` → Проверить хост |

---

## 11. Лучшие практики

| **Практика** | **Описание** | **Пример** |
|------------------------|-----------------------------------------------------------------------------|-----------------------------------------------------------------------------|
| Драйвер Docker | Быстрее и легче VirtualBox | `minikube start --driver=docker` |
| Оптимизация ресурсов | 2 CPU, 4 ГБ RAM для разработки | `minikube start --cpus=2 --memory=4000` |
| Автоматизация | Использовать Helm или `kubectl apply` для воспроизводимости | ```bash<br>minikube start --driver=docker<br>minikube addons enable ingress<br>kubectl apply -f deployment.yaml<br>``` |
| Монтирование | Использовать `mount` для разработки | `minikube mount /home/user/data:/data` |
| Локальные образы | Сборка через `minikube image build` | `minikube image build -t my-image:latest .` |

---

## 12. Заключение

Minikube — мощный инструмент для локальной разработки и тестирования Kubernetes. Это сжатое руководство охватывает все команды, настройки и сценарии, включая Helm, Ingress и TLS. Следуйте лучшим практикам и используйте таблицы для быстрого доступа к информации.
