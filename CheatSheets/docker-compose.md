# Руководство по использованию Docker Compose для начинающих

## Содержание
1. [Введение в Docker Compose](#введение-в-docker-compose)
2. [Основные компоненты и термины](#основные-компоненты-и-термины)
3. [Ключевые команды Docker Compose](#ключевые-команды-docker-compose)
4. [Конфигурация docker-compose.yml](#конфигурация-docker-compose.yml)
5. [Продвинутые сценарии и оптимизация](#продвинутые-сценарии-и-оптимизация)
6. [Пример конфигурационного файла](#пример-конфигурационного-файла)

---

## Введение в Docker Compose

Docker Compose — инструмент для управления многоконтейнерными приложениями, позволяющий описывать и запускать сложные системы через единый YAML-файл. Он упрощает настройку окружений для разработки, тестирования и продакшена, автоматизируя создание контейнеров, сетей и томов. Для новичков Docker Compose снижает сложность работы с Docker, предоставляя интуитивный интерфейс для управления зависимостями и конфигурациями. Таблица ниже систематизирует основы инструмента, включая его назначение, ключевые параметры и типичные ошибки. Она помогает быстро понять, как начать работу, и избежать распространенных проблем, таких как конфликты версий или неправильная установка.

---

### Таблица: Основы Docker Compose

| Аспект | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|--------|------------|-----------|---------|------------------|---------|----------------|
| **Инструмент Docker Compose** | Управление многоконтейнерными приложениями через YAML-файл. | `-f` (указание файла), `--project-name` (имя проекта). | ```bash<br># Запуск с указанным файлом<br>docker-compose -f custom-compose.yml up<br># Запуск с именем проекта<br>docker-compose --project-name myapp up<br># Проверка версии<br>docker-compose --version<br>``` | **Ошибка**: `docker-compose: command not found`.<br>**Решение**: Установить Docker Compose (`sudo apt install docker-compose` на Linux).<br>**Ошибка**: Конфликт версий.<br>**Решение**: Использовать `docker compose` (без дефиса) для Docker v2. | Упрощает автоматизацию и переносимость приложений. | Интегрируется с Docker CLI, Docker Hub, CI/CD-системами. |
| **Совместимость** | Работает на Linux, macOS, Windows (с WSL2). | `--compatibility` (для старых версий). | ```bash<br># Запуск в режиме совместимости<br>docker-compose --compatibility up<br># Проверка конфигурации<br>docker-compose config<br>``` | **Ошибка**: Ошибка WSL2 на Windows.<br>**Решение**: Включить WSL2 и установить Docker Desktop.<br>**Ошибка**: Отсутствие прав.<br>**Решение**: Использовать `sudo` или добавить пользователя в группу `docker`. | Зависит от версии Docker и ОС. | Требует Docker Engine; конфликты с устаревшими версиями. |

**Важно запомнить**: Docker Compose v2 интегрирован в Docker CLI (`docker compose`), v1 — отдельный пакет (`docker-compose`). Используйте последнюю версию для новых проектов.

**Типичные ошибки**: Неправильная установка (например, установка v1 вместо v2) или отсутствие Docker Engine.

---

## Основные компоненты и термины

Компоненты и термины Docker Compose формируют основу для работы с многоконтейнерными приложениями. Службы задают контейнеры, сети обеспечивают их взаимодействие, а тома сохраняют данные. Понимание этих элементов позволяет новичкам эффективно проектировать и управлять приложениями. Таблица ниже детализирует ключевые компоненты и термины, их параметры, примеры и возможные проблемы. Она помогает быстро освоить терминологию и избежать ошибок, таких как неправильная настройка сетей или томов, а также понять, как компоненты влияют друг на друга в системе.

---

### Таблица: Компоненты и термины Docker Compose

| Компонент/Термин | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|-------------------|------------|-----------|---------|------------------|---------|----------------|
| **Служба (Service)** | Определяет контейнер с настройками. | `image`, `build`, `ports`, `environment`. | ```yaml<br>services:<br>  web:<br>    image: nginx:latest<br>    ports:<br>      - "80:80"<br>```<br>```yaml<br>services:<br>  app:<br>    build: ./app<br>    environment:<br>      - APP_ENV=prod<br>``` | **Ошибка**: Образ не найден.<br>**Решение**: Проверить Docker Hub или путь к Dockerfile.<br>**Ошибка**: Контейнер не запускается.<br>**Решение**: Проверить логи (`docker-compose logs`). | Определяет поведение контейнера. | Зависит от сетей, томов, других служб. |
| **Сеть (Network)** | Обеспечивает связь между контейнерами. | `driver` (bridge, overlay), `name`. | ```yaml<br>networks:<br>  app_net:<br>    driver: bridge<br>```<br>```yaml<br>services:<br>  web:<br>    networks:<br>      - app_net<br>``` | **Ошибка**: Контейнеры не видят друг друга.<br>**Решение**: Указать одну сеть для служб.<br>**Ошибка**: Конфликт имен сетей.<br>**Решение**: Использовать уникальные имена. | Изолирует или объединяет контейнеры. | Влияет на доступность служб. |
| **Том (Volume)** | Хранит данные вне контейнера. | `type` (volume, bind), `source`, `target`. | ```yaml<br>volumes:<br>  db_data:<br>services:<br>  db:<br>    volumes:<br>      - db_data:/data<br>```<br>```yaml<br>services:<br>  app:<br>    volumes:<br>      - ./src:/app<br>``` | **Ошибка**: Том не монтируется.<br>**Решение**: Проверить путь на хосте.<br>**Ошибка**: Права доступа.<br>**Решение**: Настроить права (`chmod`). | Обеспечивает сохранность данных. | Взаимодействует с хостовой ФС и контейнерами. |
| **Образ (Image)** | Шаблон для контейнеров. | `image`, `build`. | ```yaml<br>services:<br>  web:<br>    image: python:3.9<br>```<br>```yaml<br>services:<br>  app:<br>    build: .<br>``` | **Ошибка**: Устаревший образ.<br>**Решение**: Выполнить `docker-compose pull`.<br>**Ошибка**: Ошибка сборки.<br>**Решение**: Проверить Dockerfile. | Определяет содержимое контейнера. | Связан с Docker Hub и Dockerfile. |
| **Контейнер** | Изолированная среда для приложения. | `command`, `entrypoint`. | ```yaml<br>services:<br>  web:<br>    command: python app.py<br>```<br>```yaml<br>services:<br>  db:<br>    entrypoint: /start.sh<br>``` | **Ошибка**: Контейнер завершает работу.<br>**Решение**: Проверить код возврата (`docker-compose ps`).<br>**Ошибка**: Конфликт портов.<br>**Решение**: Изменить порт в `ports`. | Запускает приложение. | Зависит от образа, сети, томов. |

**Важно запомнить**: Службы определяют контейнеры, сети — их связь, тома — хранение данных. Используйте именованные тома для переносимости.

**Типичные ошибки**: Неправильные пути к томам, отсутствие указания сети, устаревшие образы.

---

## Ключевые команды Docker Compose

Команды Docker Compose позволяют управлять жизненным циклом многоконтейнерных приложений, от запуска до мониторинга и удаления. Они являются основным инструментом для работы с проектами, упрощая задачи, такие как отладка, масштабирование и обновление. Таблица ниже описывает ключевые команды, их параметры, примеры и потенциальные проблемы. Она помогает новичкам быстро освоить управление приложениями, избегая ошибок, таких как конфликты портов или неправильное удаление ресурсов, и понять, как команды взаимодействуют с компонентами системы.

---

### Таблица: Ключевые команды Docker Compose

| Команда | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|---------|------------|-----------|---------|------------------|---------|----------------|
| **docker-compose up** | Запускает службы, сети, тома. | `-d` (фоновый режим), `--build` (пересборка). | ```bash<br># Запуск в фоновом режиме<br>docker-compose up -d<br># Пересборка и запуск<br>docker-compose up --build<br># Запуск с масштабированием<br>docker-compose up --scale web=3<br>``` | **Ошибка**: Порт занят.<br>**Решение**: Изменить порт в `ports`.<br>**Ошибка**: Образ не найден.<br>**Решение**: Выполнить `docker-compose pull`. | Создает и запускает ресурсы. | Влияет на сети, тома, контейнеры. |
| **docker-compose down** | Останавливает и удаляет ресурсы. | `--volumes` (удаление томов), `--rmi` (удаление образов). | ```bash<br># Полная очистка<br>docker-compose down --volumes<br># Удаление с образами<br>docker-compose down --rmi all<br>``` | **Ошибка**: Тома не удаляются.<br>**Решение**: Добавить `--volumes`.<br>**Ошибка**: Зависшие контейнеры.<br>**Решение**: Выполнить `docker-compose rm`. | Удаляет все ресурсы проекта. | Освобождает порты, сети, тома. |
| **docker-compose ps** | Показывает статус контейнеров. | `-q` (только ID), `--services` (список служб). | ```bash<br># Список контейнеров<br>docker-compose ps<br># Только ID<br>docker-compose ps -q<br>``` | **Ошибка**: Нет запущенных контейнеров.<br>**Решение**: Запустить `docker-compose up`.<br>**Ошибка**: Неправильный проект.<br>**Решение**: Указать `--project-name`. | Показывает состояние. | Не изменяет ресурсы. |
| **docker-compose logs** | Показывает логи контейнеров. | `--tail` (кол-во строк), `-f` (поток). | ```bash<br># Показать последние 100 строк<br>docker-compose logs --tail 100<br># Поток логов<br>docker-compose logs -f<br>``` | **Ошибка**: Логи пусты.<br>**Решение**: Проверить, запущены ли службы.<br>**Ошибка**: Слишком много данных.<br>**Решение**: Использовать `--tail`. | Помогает в отладке. | Не влияет на ресурсы. |
| **docker-compose exec** | Выполняет команду в контейнере. | `-it` (интерактивный режим). | ```bash<br># Запуск bash<br>docker-compose exec web bash<br># Выполнение команды<br>docker-compose exec db psql -U user<br>``` | **Ошибка**: Контейнер не запущен.<br>**Решение**: Запустить `docker-compose up`.<br>**Ошибка**: Команда не найдена.<br>**Решение**: Проверить образ. | Выполняет действия в контейнере. | Зависит от состояния контейнера. |

**Важно запомнить**: Используйте `-d` для фонового запуска, `--build` для пересборки, `--volumes` для очистки.

**Типичные ошибки**: Неправильное имя проекта, занятые порты, отсутствие запущенных контейнеров.

---

## Конфигурация docker-compose.yml

Файл `docker-compose.yml` определяет структуру многоконтейнерного приложения, включая службы, сети, тома и их настройки. Он является центральным элементом Docker Compose, позволяя описать все зависимости и параметры в одном месте. Таблица ниже детализирует ключевые параметры файла, их назначение, примеры и возможные ошибки. Она помогает новичкам правильно настроить конфигурацию, избегая проблем, таких как неправильный синтаксис или конфликты ресурсов, и понять, как параметры влияют на поведение приложения.

---

### Таблица: Параметры docker-compose.yml

| Параметр | Назначение | Варианты | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|----------|------------|----------|---------|------------------|---------|----------------|
| **version** | Указывает версию формата YAML. | `3.x`, `2.x`. | ```yaml<br>version: '3.8'<br>``` | **Ошибка**: Неверная версия.<br>**Решение**: Проверить совместимость с Docker.<br>**Ошибка**: Отсутствует.<br>**Решение**: Добавить `version`. | Определяет доступные функции. | Влияет на все параметры. |
| **services** | Определяет контейнеры. | `image`, `build`, `ports`. | ```yaml<br>services:<br>  web:<br>    image: nginx<br>    ports:<br>      - "80:80"<br>```<br>```yaml<br>services:<br>  app:<br>    build: .<br>    environment:<br>      - APP_ENV=prod<br>``` | **Ошибка**: Служба не запускается.<br>**Решение**: Проверить логи.<br>**Ошибка**: Неправильный образ.<br>**Решение**: Указать корректный `image`. | Задает поведение контейнеров. | Взаимодействует с сетями, томами. |
| **volumes** | Хранит данные. | `type`, `source`, `target`. | ```yaml<br>volumes:<br>  db_data:<br>services:<br>  db:<br>    volumes:<br>      - db_data:/data<br>```<br>```yaml<br>services:<br>  app:<br>    volumes:<br>      - ./src:/app<br>``` | **Ошибка**: Том не найден.<br>**Решение**: Создать том явно.<br>**Ошибка**: Права доступа.<br>**Решение**: Настроить права. | Сохраняет данные. | Влияет на хост и контейнеры. |
| **networks** | Определяет сети. | `driver`, `name`. | ```yaml<br>networks:<br>  app_net:<br>    driver: bridge<br>services:<br>  web:<br>    networks:<br>      - app_net<br>``` | **Ошибка**: Сеть не найдена.<br>**Решение**: Создать сеть явно.<br>**Ошибка**: Контейнеры не связаны.<br>**Решение**: Указать сеть для служб. | Обеспечивает связь. | Влияет на службы. |
| **environment** | Задает переменные окружения. | Список или файл `.env`. | ```yaml<br>services:<br>  web:<br>    environment:<br>      - APP_ENV=prod<br>```<br>```yaml<br>services:<br>  db:<br>    env_file:<br>      - .env<br>``` | **Ошибка**: Переменная не передана.<br>**Решение**: Проверить синтаксис.<br>**Ошибка**: Файл `.env` не найден.<br>**Решение**: Указать правильный путь. | Настраивает поведение. | Влияет на приложение в контейнере. |

**Важно запомнить**: Используйте `version: '3.8'` для новых проектов, проверяйте пути к томам и образам.

**Типичные ошибки**: Неправильный синтаксис YAML, отсутствие томов или сетей, конфликты портов.

---

## Продвинутые сценарии и оптимизация

Продвинутые сценарии Docker Compose включают масштабирование, управление секретами, интеграцию с CI/CD и оптимизацию ресурсов. Эти возможности позволяют создавать устойчивые и автоматизированные окружения для продакшена. Таблица ниже описывает сложные конфигурации и команды, их параметры, примеры и потенциальные проблемы. Она помогает новичкам перейти к профессиональному использованию, избегая ошибок, таких как неправильная настройка секретов или перерасход ресурсов, и понять, как интегрировать Docker Compose в сложные рабочие процессы.

---

### Таблица: Продвинутые сценарии

| Сценарий | Назначение | Параметры | Примеры | Ошибки и решения | Влияние | Взаимодействие |
|----------|------------|----------|---------|------------------|---------|----------------|
| **Масштабирование** | Увеличивает количество контейнеров. | `--scale`, `replicas`. | ```bash<br># Масштабирование службы<br>docker-compose up --scale web=3<br>```<br>```yaml<br>services:<br>  web:<br>    deploy:<br>      replicas: 3<br>``` | **Ошибка**: Конфликт портов.<br>**Решение**: Использовать балансировщик нагрузки.<br>**Ошибка**: Недостаточно ресурсов.<br>**Решение**: Увеличить лимиты. | Повышает доступность. | Требует балансировщика (например, nginx). |
| **Секреты** | Хранит конфиденциальные данные. | `secrets`, `external`. | ```yaml<br>services:<br>  app:<br>    secrets:<br>      - db_pass<br>secrets:<br>  db_pass:<br>    file: ./db_pass.txt<br>``` | **Ошибка**: Секрет не найден.<br>**Решение**: Проверить путь к файлу.<br>**Ошибка**: Утечка данных.<br>**Решение**: Ограничить доступ. | Повышает безопасность. | Взаимодействует с контейнерами. |
| **Автоматизация CI/CD** | Интеграция с CI/CD. | `build`, `push`. | ```bash<br># Сборка и отправка<br>docker-compose build<br>docker-compose push<br>```<br>```yaml<br>services:<br>  app:<br>    build: .<br>    image: myrepo/app:latest<br>``` | **Ошибка**: Ошибка авторизации.<br>**Решение**: Выполнить `docker login`.<br>**Ошибка**: Неправильный тег.<br>**Решение**: Указать корректный `image`. | Ускоряет развертывание. | Интегрируется с GitHub Actions, Jenkins. |
| **Ограничение ресурсов** | Контролирует использование CPU/памяти. | `deploy.resources`. | ```yaml<br>services:<br>  web:<br>    deploy:<br>      resources:<br>        limits:<br>          cpus: '0.5'<br>          memory: 512M<br>``` | **Ошибка**: Превышение лимитов.<br>**Решение**: Увеличить лимиты.<br>**Ошибка**: Ресурсы не применяются.<br>**Решение**: Использовать Swarm. | Стабилизирует систему. | Влияет на производительность. |

**Важно запомнить**: Используйте секреты для конфиденциальных данных, масштабирование с балансировщиком, автоматизацию для CI/CD.

**Типичные ошибки**: Неправильная настройка секретов, конфликты при масштабировании, ошибки авторизации в реестре.

---

## Пример конфигурационного файла

Пример файла `docker-compose.yml` демонстрирует типичную конфигурацию для многоконтейнерного приложения, включающего веб-приложение и базу данных. Он иллюстрирует использование ключевых параметров, таких как `services`, `volumes`, `networks`, `environment` и `deploy`, с подробными комментариями для понимания каждого элемента. Этот пример помогает новичкам увидеть практическое применение Docker Compose и использовать его как шаблон для собственных проектов. Таблица отсутствует, так как пример сам по себе является полным и самодостаточным, а комментарии в коде объясняют назначение каждого параметра.

---

```yaml
# Версия спецификации Docker Compose (version)
# Указывает версию формата файла docker-compose.yml.
# Например, версия 3.x поддерживает новые функции, такие как deploy.
# Пример: version: '3.8'
version: '3.8'

# Определяем сервисы (services)
# services — это основной раздел, где описываются контейнеры.
# Каждый сервис представляет собой отдельный контейнер.
services:
  # Первый сервис: веб-приложение
  web:
    # Используем базовый образ (image)
    # image указывает, какой образ будет использоваться для контейнера.
    # Можно использовать готовый образ из Docker Hub или собственный.
    # Пример: image: python:3.9
    image: python:3.9

    # Альтернатива: сборка образа из Dockerfile (build)
    # build указывает путь к Dockerfile для создания образа.
    # context — корневая директория для сборки.
    # dockerfile — имя Dockerfile (по умолчанию "Dockerfile").
    # Пример 1: Сборка из текущей директории
    # build: .
    # Пример 2: Сборка с указанием контекста и Dockerfile
    # build:
    #   context: ./web
    #   dockerfile: Dockerfile.prod

    # Указываем команду для запуска контейнера (command)
    # command заменяет CMD в Dockerfile.
    # Пример 1: Запуск Python-скрипта
    command: python app.py
    # Пример 2: Передача нескольких аргументов
    # command: ["python", "app.py", "--debug"]

    # Публикуем порты (ports)
    # ports связывает порты хостовой системы с портами контейнера.
    # Формат: "хост:контейнер".
    # Пример 1: Открытие порта 8000
    ports:
      - "8000:8000"
    # Пример 2: Открытие нескольких портов
    # ports:
    #   - "8000:8000"
    #   - "8080:80"
    # Пример 3: Только внутренний порт (доступен только внутри сети Docker)
    # ports:
    #   - "8000"

    # Монтируем тома (volumes)
    # volumes позволяют монтировать директории или файлы между хостом и контейнером.
    # Пример 1: Монтирование директории с кодом
    volumes:
      - ./src:/app
    # Пример 2: Монтирование локального файла
    # volumes:
    #   - ./config.json:/app/config.json
    # Пример 3: Монтирование именованного тома
    # volumes:
    #   - data_volume:/data

    # Указываем переменные окружения (environment)
    # environment задает переменные окружения внутри контейнера.
    # Пример 1: Явное указание переменных
    environment:
      APP_ENV: production
      LOG_LEVEL: info
    # Пример 2: Загрузка переменных из файла
    # env_file:
    #   - .env

    # Указываем зависимости (depends_on)
    # depends_on определяет порядок запуска контейнеров.
    # Важно: Это только гарантирует порядок запуска, но не ждет готовности сервисов.
    # Для проверки готовности используйте скрипты или инструменты вроде wait-for-it.sh.
    depends_on:
      - db

    # Задаем метки для контейнера (labels)
    # labels добавляют метаданные к контейнеру.
    # Пример:
    labels:
      com.example.description: "Web application"
      com.example.version: "1.0"

    # Указываем сетевые настройки (networks)
    # networks задает сети, к которым подключается контейнер.
    # Пример:
    networks:
      - app_network

    # Ограничиваем ресурсы (deploy)
    # deploy позволяет настроить ресурсы для контейнера (например, CPU, память).
    # Работает только в режиме Docker Swarm.
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Второй сервис: база данных
  db:
    # Используем базовый образ PostgreSQL
    image: postgres:13

    # Указываем переменные окружения для PostgreSQL
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb

    # Монтируем том для хранения данных базы данных
    volumes:
      - db_data:/var/lib/postgresql/data

    # Подключаемся к пользовательской сети
    networks:
      - app_network

# Определяем именованные тома (volumes)
# volumes создают именованные тома для хранения данных.
# Пример 1: Создание тома db_data
volumes:
  db_data:
  # Пример 2: Создание дополнительного тома
  data_volume:

# Определяем сети (networks)
# networks создают пользовательские сети для связи контейнеров.
# Пример: Создание сети app_network с драйвером bridge
networks:
  app_network:
    driver: bridge
```